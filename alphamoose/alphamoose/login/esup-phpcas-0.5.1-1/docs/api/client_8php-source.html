<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>phpCAS: CAS/client.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.0 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    <li><a href="examples.html"><span>Examples</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>CAS/client.php</h1><a href="client_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00008"></a>00008 <span class="comment">// include internationalization stuff</span>
<a name="l00009"></a>00009 include_once(dirname(__FILE__).'/languages/languages.php');
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">// include PGT storage classes</span>
<a name="l00012"></a>00012 include_once(dirname(__FILE__).'/<a class="code" href="classPGTStorage.html">PGTStorage</a>/pgt-main.php');
<a name="l00013"></a>00013 
<a name="l00022"></a><a class="code" href="classCASClient.html">00022</a> <span class="keyword">class </span><a class="code" href="classCASClient.html">CASClient</a>
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024 
<a name="l00025"></a>00025   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00026"></a>00026   <span class="comment">// XX                                                                    XX</span>
<a name="l00027"></a>00027   <span class="comment">// XX                          CONFIGURATION                             XX</span>
<a name="l00028"></a>00028   <span class="comment">// XX                                                                    XX</span>
<a name="l00029"></a>00029   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031   <span class="comment">// ########################################################################</span>
<a name="l00032"></a>00032   <span class="comment">//  HTML OUTPUT</span>
<a name="l00033"></a>00033   <span class="comment">// ########################################################################</span>
<a name="l00052"></a><a class="code" href="group__internalOutput.html#g14f7344590b9ea8bc75cf406e6b72e1d">00052</a> <span class="comment"></span>  function <a class="code" href="group__internalOutput.html#g14f7344590b9ea8bc75cf406e6b72e1d">HTMLFilterOutput</a>($str)
<a name="l00053"></a>00053     {
<a name="l00054"></a>00054       $str = str_replace('__CAS_VERSION__',$this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>(),$str);
<a name="l00055"></a>00055       $str = str_replace('__PHPCAS_VERSION__',<a class="code" href="group__public.html#gba9981b7e9d000cd2023da901c2b71dd">phpCAS::getVersion</a>(),$str);
<a name="l00056"></a>00056       $str = str_replace('__SERVER_BASE_URL__',$this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>(),$str);
<a name="l00057"></a>00057       echo $str;
<a name="l00058"></a>00058     }
<a name="l00059"></a>00059 
<a name="l00068"></a><a class="code" href="group__internalOutput.html#g657b1ef45e433939dcd7b770a15afa30">00068</a>   var <a class="code" href="group__internalOutput.html#g657b1ef45e433939dcd7b770a15afa30">$_output_header</a> = '';
<a name="l00069"></a>00069   
<a name="l00079"></a><a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">00079</a>   function <a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">printHTMLHeader</a>($title)
<a name="l00080"></a>00080     {
<a name="l00081"></a>00081       $this-&gt;<a class="code" href="group__internalOutput.html#g14f7344590b9ea8bc75cf406e6b72e1d">HTMLFilterOutput</a>(str_replace('__TITLE__',
<a name="l00082"></a>00082                                           $title,
<a name="l00083"></a>00083                                           (empty($this-&gt;_output_header)
<a name="l00084"></a>00084                                            ? '&lt;html&gt;&lt;head&gt;&lt;title&gt;__TITLE__&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;__TITLE__&lt;/h1&gt;'
<a name="l00085"></a>00085                                            : $this-&gt;_output_header)
<a name="l00086"></a>00086                                           )
<a name="l00087"></a>00087                               );
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089 
<a name="l00098"></a><a class="code" href="group__internalOutput.html#g9d26cc162f6545be562a29957cb7a1d6">00098</a>   var <a class="code" href="group__internalOutput.html#g9d26cc162f6545be562a29957cb7a1d6">$_output_footer</a> = '';
<a name="l00099"></a>00099   
<a name="l00107"></a><a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">00107</a>   function <a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">printHTMLFooter</a>()
<a name="l00108"></a>00108     {
<a name="l00109"></a>00109       $this-&gt;<a class="code" href="group__internalOutput.html#g14f7344590b9ea8bc75cf406e6b72e1d">HTMLFilterOutput</a>(empty($this-&gt;_output_footer)
<a name="l00110"></a>00110                               ?('&lt;hr&gt;&lt;address&gt;<a class="code" href="classphpCAS.html">phpCAS</a> __PHPCAS_VERSION__ '.$this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#5240d70ccee91bef362f140ac1b2ed00">CAS_STR_USING_SERVER</a>).' &lt;a href=<span class="stringliteral">"__SERVER_BASE_URL__"</span>&gt;__SERVER_BASE_URL__&lt;/a&gt; (CAS __CAS_VERSION__)&lt;/a&gt;&lt;/address&gt;&lt;/body&gt;&lt;/html&gt;')
<a name="l00111"></a>00111                               :$this-&gt;_output_footer);
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 
<a name="l00121"></a><a class="code" href="group__internalOutput.html#g4b1b9ad5ad4201f028ec8d0e18b18c53">00121</a>   function <a class="code" href="group__internalOutput.html#g4b1b9ad5ad4201f028ec8d0e18b18c53">setHTMLHeader</a>($header)
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123       $this-&gt;_output_header = $header;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 
<a name="l00133"></a><a class="code" href="group__internalOutput.html#gbf7142cdd0ce86dc8f79b09777d705c7">00133</a>   function <a class="code" href="group__internalOutput.html#gbf7142cdd0ce86dc8f79b09777d705c7">setHTMLFooter</a>($footer)
<a name="l00134"></a>00134     {
<a name="l00135"></a>00135       $this-&gt;_output_footer = $footer;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00139"></a>00139   <span class="comment">// ########################################################################</span>
<a name="l00140"></a>00140   <span class="comment">//  INTERNATIONALIZATION</span>
<a name="l00141"></a>00141   <span class="comment">// ########################################################################</span>
<a name="l00156"></a><a class="code" href="group__internalLang.html#g1895c3f377e0b35564a46e897155cd69">00156</a> <span class="comment"></span>  var <a class="code" href="group__internalLang.html#g1895c3f377e0b35564a46e897155cd69">$_lang</a> = '';
<a name="l00157"></a>00157   
<a name="l00165"></a><a class="code" href="group__internalLang.html#g2c56528158e1cfc31f84dd03b3ef3464">00165</a>   function <a class="code" href="group__internalLang.html#g2c56528158e1cfc31f84dd03b3ef3464">getLang</a>()
<a name="l00166"></a>00166     {
<a name="l00167"></a>00167       <span class="keywordflow">if</span> ( empty($this-&gt;_lang) )
<a name="l00168"></a>00168         $this-&gt;<a class="code" href="group__internalLang.html#gd9e3665f38b85df23d2526e259bbf59a">setLang</a>(<a class="code" href="group__internalLang.html#g09705919fa8acfdfe25b3d8bf78309ac">PHPCAS_LANG_DEFAULT</a>);
<a name="l00169"></a>00169       <span class="keywordflow">return</span> $this-&gt;_lang;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171 
<a name="l00181"></a><a class="code" href="group__internalLang.html#gb8f7d2cc01562b5bc7520d1d501d8796">00181</a>   var <a class="code" href="group__internalLang.html#gb8f7d2cc01562b5bc7520d1d501d8796">$_strings</a>;
<a name="l00182"></a>00182 
<a name="l00192"></a><a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">00192</a>   function <a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>($str)
<a name="l00193"></a>00193     {
<a name="l00194"></a>00194       <span class="comment">// call CASclient::getLang() to be sure the language is initialized</span>
<a name="l00195"></a>00195       $this-&gt;<a class="code" href="group__internalLang.html#g2c56528158e1cfc31f84dd03b3ef3464">getLang</a>();
<a name="l00196"></a>00196       
<a name="l00197"></a>00197       <span class="keywordflow">if</span> ( !isset($this-&gt;<a class="code" href="english_8php.html#3e2715c2e334fb91d34437e4ff025f1f">_strings</a>[$str]) ) {
<a name="l00198"></a>00198         trigger_error('string `'.$str.<span class="charliteral">'\'</span> not defined <span class="keywordflow">for</span> language `'.$this-&gt;<a class="code" href="group__internalLang.html#g2c56528158e1cfc31f84dd03b3ef3464">getLang</a>().<span class="charliteral">'\''</span>,E_USER_ERROR);
<a name="l00199"></a>00199       }
<a name="l00200"></a>00200       <span class="keywordflow">return</span> $this-&gt;<a class="code" href="english_8php.html#3e2715c2e334fb91d34437e4ff025f1f">_strings</a>[$str];
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00212"></a><a class="code" href="group__internalLang.html#gd9e3665f38b85df23d2526e259bbf59a">00212</a>   function <a class="code" href="group__internalLang.html#gd9e3665f38b85df23d2526e259bbf59a">setLang</a>($lang)
<a name="l00213"></a>00213     {
<a name="l00214"></a>00214       <span class="comment">// include the corresponding language file</span>
<a name="l00215"></a>00215       include_once(dirname(__FILE__).'/languages/'.$lang.'.php');
<a name="l00216"></a>00216 
<a name="l00217"></a>00217       <span class="keywordflow">if</span> ( !is_array($this-&gt;<a class="code" href="english_8php.html#3e2715c2e334fb91d34437e4ff025f1f">_strings</a>) ) {
<a name="l00218"></a>00218         trigger_error('language `'.$lang.<span class="charliteral">'\'</span> is not implemented',E_USER_ERROR);
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220       $this-&gt;_lang = $lang;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00224"></a>00224   <span class="comment">// ########################################################################</span>
<a name="l00225"></a>00225   <span class="comment">//  CAS SERVER CONFIG</span>
<a name="l00226"></a>00226   <span class="comment">// ########################################################################</span>
<a name="l00256"></a><a class="code" href="group__internalConfig.html#g8ecf31d278a963de084af52286ebc530">00256</a> <span class="comment"></span>  var <a class="code" href="group__internalConfig.html#g8ecf31d278a963de084af52286ebc530">$_server</a> = array(
<a name="l00257"></a>00257                        'version' =&gt; -1,
<a name="l00258"></a>00258                        'hostname' =&gt; 'none',
<a name="l00259"></a>00259                        'port' =&gt; -1,
<a name="l00260"></a>00260                        'uri' =&gt; 'none'
<a name="l00261"></a>00261                        );
<a name="l00262"></a>00262   
<a name="l00268"></a><a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">00268</a>   function <a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()
<a name="l00269"></a>00269     { 
<a name="l00270"></a>00270       <span class="keywordflow">return</span> $this-&gt;_server['version']; 
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 
<a name="l00278"></a><a class="code" href="group__internalConfig.html#g40298cacb4ec16a66e9579126f72a2c9">00278</a>   function <a class="code" href="group__internalConfig.html#g40298cacb4ec16a66e9579126f72a2c9">getServerHostname</a>()
<a name="l00279"></a>00279     { <span class="keywordflow">return</span> $this-&gt;_server['hostname']; }
<a name="l00280"></a>00280 
<a name="l00286"></a><a class="code" href="group__internalConfig.html#ge39e257df8278aedc313782b8ec4f087">00286</a>   function <a class="code" href="group__internalConfig.html#ge39e257df8278aedc313782b8ec4f087">getServerPort</a>()
<a name="l00287"></a>00287     { <span class="keywordflow">return</span> $this-&gt;_server['port']; }
<a name="l00288"></a>00288 
<a name="l00294"></a><a class="code" href="group__internalConfig.html#g5ddf106ed3c6fb584f41f30cff8efae9">00294</a>   function <a class="code" href="group__internalConfig.html#g5ddf106ed3c6fb584f41f30cff8efae9">getServerURI</a>()
<a name="l00295"></a>00295     { <span class="keywordflow">return</span> $this-&gt;_server['uri']; }
<a name="l00296"></a>00296 
<a name="l00302"></a><a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">00302</a>   function <a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>()
<a name="l00303"></a>00303     { 
<a name="l00304"></a>00304       <span class="comment">// the URL is build only when needed</span>
<a name="l00305"></a>00305       <span class="keywordflow">if</span> ( empty($this-&gt;_server['base_url']) ) {
<a name="l00306"></a>00306         $this-&gt;_server['base_url'] = 'https:<span class="comment">//'</span>
<a name="l00307"></a>00307           .$this-&gt;getServerHostname()
<a name="l00308"></a>00308           .<span class="charliteral">':'</span>
<a name="l00309"></a>00309           .$this-&gt;getServerPort()
<a name="l00310"></a>00310           .$this-&gt;getServerURI();
<a name="l00311"></a>00311       }
<a name="l00312"></a>00312       <span class="keywordflow">return</span> $this-&gt;_server['base_url']; 
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00321"></a><a class="code" href="group__internalConfig.html#g9f61cf3e3f245ac17836fa52d9c17e5b">00321</a>   function <a class="code" href="group__internalConfig.html#g9f61cf3e3f245ac17836fa52d9c17e5b">getServerLoginURL</a>($gateway=<span class="keyword">false</span>)
<a name="l00322"></a>00322     { 
<a name="l00323"></a>00323       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00324"></a>00324       <span class="comment">// the URL is build only when needed</span>
<a name="l00325"></a>00325       <span class="keywordflow">if</span> ( empty($this-&gt;_server['login_url']) ) {
<a name="l00326"></a>00326         $this-&gt;_server['login_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>();
<a name="l00327"></a>00327         $this-&gt;_server['login_url'] .= 'login?service=';
<a name="l00328"></a>00328 <span class="comment">//        $this-&gt;_server['login_url'] .= preg_replace('/&amp;/','%26',$this-&gt;getURL());</span>
<a name="l00329"></a>00329         $this-&gt;_server['login_url'] .= urlencode($this-&gt;<a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">getURL</a>());
<a name="l00330"></a>00330         <span class="keywordflow">if</span> ($gateway) {
<a name="l00331"></a>00331           $this-&gt;_server['login_url'] .= '&amp;gateway=<span class="keyword">true</span>';
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333       }
<a name="l00334"></a>00334       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($this-&gt;_server['login_url']);
<a name="l00335"></a>00335       <span class="keywordflow">return</span> $this-&gt;_server['login_url']; 
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00344"></a><a class="code" href="group__internalConfig.html#g4ce0ed78f2a774c4c8e93f6967a5a7a4">00344</a>   function <a class="code" href="group__internalConfig.html#g4ce0ed78f2a774c4c8e93f6967a5a7a4">setServerLoginURL</a>($url)
<a name="l00345"></a>00345     {
<a name="l00346"></a>00346       <span class="keywordflow">return</span> $this-&gt;_server['login_url'] = $url;
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348 
<a name="l00354"></a><a class="code" href="group__internalConfig.html#g9bbd5b923772625ee3fc23ef07a641d3">00354</a>   function <a class="code" href="group__internalConfig.html#g9bbd5b923772625ee3fc23ef07a641d3">getServerServiceValidateURL</a>()
<a name="l00355"></a>00355     { 
<a name="l00356"></a>00356       <span class="comment">// the URL is build only when needed</span>
<a name="l00357"></a>00357       <span class="keywordflow">if</span> ( empty($this-&gt;_server['service_validate_url']) ) {
<a name="l00358"></a>00358         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l00359"></a>00359         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l00360"></a>00360           $this-&gt;_server['service_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>().'validate';
<a name="l00361"></a>00361           <span class="keywordflow">break</span>;
<a name="l00362"></a>00362         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l00363"></a>00363           $this-&gt;_server['service_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>().'serviceValidate';
<a name="l00364"></a>00364           <span class="keywordflow">break</span>;
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366       }
<a name="l00367"></a>00367 <span class="comment">//      return $this-&gt;_server['service_validate_url'].'?service='.preg_replace('/&amp;/','%26',$this-&gt;getURL()); </span>
<a name="l00368"></a>00368       <span class="keywordflow">return</span> $this-&gt;_server['service_validate_url'].'?service='.urlencode($this-&gt;<a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">getURL</a>()); 
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370 
<a name="l00376"></a><a class="code" href="group__internalConfig.html#g900e70b93d8aa16bccd11de19c9322f6">00376</a>   function <a class="code" href="group__internalConfig.html#g900e70b93d8aa16bccd11de19c9322f6">getServerProxyValidateURL</a>()
<a name="l00377"></a>00377     { 
<a name="l00378"></a>00378       <span class="comment">// the URL is build only when needed</span>
<a name="l00379"></a>00379       <span class="keywordflow">if</span> ( empty($this-&gt;_server['proxy_validate_url']) ) {
<a name="l00380"></a>00380         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l00381"></a>00381         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l00382"></a>00382           $this-&gt;_server['proxy_validate_url'] = '';
<a name="l00383"></a>00383           <span class="keywordflow">break</span>;
<a name="l00384"></a>00384         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l00385"></a>00385           $this-&gt;_server['proxy_validate_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>().'proxyValidate';
<a name="l00386"></a>00386           <span class="keywordflow">break</span>;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388       }
<a name="l00389"></a>00389 <span class="comment">//      return $this-&gt;_server['proxy_validate_url'].'?service='.preg_replace('/&amp;/','%26',$this-&gt;getURL()); </span>
<a name="l00390"></a>00390       <span class="keywordflow">return</span> $this-&gt;_server['proxy_validate_url'].'?service='.urlencode($this-&gt;<a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">getURL</a>()); 
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00398"></a><a class="code" href="group__internalConfig.html#g9062a1ea9866c4c1e5a485c0d4ee0f80">00398</a>   function <a class="code" href="group__internalConfig.html#g9062a1ea9866c4c1e5a485c0d4ee0f80">getServerProxyURL</a>()
<a name="l00399"></a>00399     { 
<a name="l00400"></a>00400       <span class="comment">// the URL is build only when needed</span>
<a name="l00401"></a>00401       <span class="keywordflow">if</span> ( empty($this-&gt;_server['proxy_url']) ) {
<a name="l00402"></a>00402         <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l00403"></a>00403         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l00404"></a>00404           $this-&gt;_server['proxy_url'] = '';
<a name="l00405"></a>00405           <span class="keywordflow">break</span>;
<a name="l00406"></a>00406         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l00407"></a>00407           $this-&gt;_server['proxy_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>().'proxy';
<a name="l00408"></a>00408           <span class="keywordflow">break</span>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410       }
<a name="l00411"></a>00411       <span class="keywordflow">return</span> $this-&gt;_server['proxy_url']; 
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413 
<a name="l00419"></a><a class="code" href="group__internalConfig.html#ge5b55ff9a82586d2b85181de1e4dba78">00419</a>   function <a class="code" href="group__internalConfig.html#ge5b55ff9a82586d2b85181de1e4dba78">getServerLogoutURL</a>()
<a name="l00420"></a>00420     { 
<a name="l00421"></a>00421       <span class="comment">// the URL is build only when needed</span>
<a name="l00422"></a>00422       <span class="keywordflow">if</span> ( empty($this-&gt;_server['logout_url']) ) {
<a name="l00423"></a>00423         $this-&gt;_server['logout_url'] = $this-&gt;<a class="code" href="group__internalConfig.html#g99aa47964b7447d75deca1cf2c873377">getServerBaseURL</a>().'<a class="code" href="group__internalAuthentication.html#g73c09d652b42b06ca1da800d6fa4660e">logout</a>';
<a name="l00424"></a>00424       }
<a name="l00425"></a>00425       <span class="keywordflow">return</span> $this-&gt;_server['logout_url']; 
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427 
<a name="l00434"></a><a class="code" href="group__internalConfig.html#gbdc96864e422fab32d2f4412749f5239">00434</a>   function <a class="code" href="group__internalConfig.html#gbdc96864e422fab32d2f4412749f5239">setServerLogoutURL</a>($url)
<a name="l00435"></a>00435     {
<a name="l00436"></a>00436       <span class="keywordflow">return</span> $this-&gt;_server['logout_url'] = $url;
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438 
<a name="l00444"></a><a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">00444</a>   function <a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() {
<a name="l00445"></a>00445     <span class="comment">//if ( isset($_SERVER['HTTPS']) &amp;&amp; !empty($_SERVER['HTTPS']) ) {</span>
<a name="l00446"></a>00446     <span class="comment">//0.4.24 by Hinnack</span>
<a name="l00447"></a>00447     <span class="keywordflow">if</span> ( isset($_SERVER['HTTPS']) &amp;&amp; !empty($_SERVER['HTTPS']) &amp;&amp; $_SERVER['HTTPS'] == 'on') {
<a name="l00448"></a>00448       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00449"></a>00449     } <span class="keywordflow">else</span> {
<a name="l00450"></a>00450       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454   <span class="comment">// ########################################################################</span>
<a name="l00455"></a>00455   <span class="comment">//  CONSTRUCTOR</span>
<a name="l00456"></a>00456   <span class="comment">// ########################################################################</span>
<a name="l00471"></a><a class="code" href="group__internalConfig.html#g8835a61f1bd234295466079e8b3c83af">00471</a> <span class="comment"></span>  function <a class="code" href="group__internalConfig.html#g8835a61f1bd234295466079e8b3c83af">CASClient</a>(
<a name="l00472"></a>00472         $server_version,
<a name="l00473"></a>00473         $proxy,
<a name="l00474"></a>00474         $server_hostname,
<a name="l00475"></a>00475         $server_port,
<a name="l00476"></a>00476         $server_uri,
<a name="l00477"></a>00477         $start_session = <span class="keyword">true</span>) {
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="comment">//activate session mechanism if desired</span>
<a name="l00482"></a>00482     <span class="keywordflow">if</span> ($start_session) {
<a name="l00483"></a>00483       session_start();
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     $this-&gt;_proxy = $proxy;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">//check version</span>
<a name="l00489"></a>00489     <span class="keywordflow">switch</span> ($server_version) {
<a name="l00490"></a>00490       <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l00491"></a>00491         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() )
<a name="l00492"></a>00492           <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('CAS proxies are not supported in CAS '
<a name="l00493"></a>00493               .$server_version);
<a name="l00494"></a>00494         <span class="keywordflow">break</span>;
<a name="l00495"></a>00495       <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l00496"></a>00496         <span class="keywordflow">break</span>;
<a name="l00497"></a>00497       <span class="keywordflow">default</span>:
<a name="l00498"></a>00498         <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('<span class="keyword">this</span> version of CAS (`'
<a name="l00499"></a>00499             .$server_version
<a name="l00500"></a>00500             .<span class="charliteral">'\'</span>) is not supported by <a class="code" href="classphpCAS.html">phpCAS</a> '
<a name="l00501"></a>00501             .<a class="code" href="group__public.html#gba9981b7e9d000cd2023da901c2b71dd">phpCAS::getVersion</a>());
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503     $this-&gt;_server['version'] = $server_version;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="comment">//check hostname</span>
<a name="l00506"></a>00506     <span class="keywordflow">if</span> ( empty($server_hostname) 
<a name="l00507"></a>00507         || !preg_match('/[\.\d\-abcdefghijklmnopqrstuvwxyz]*/',$server_hostname) ) {
<a name="l00508"></a>00508       <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('bad CAS server hostname (`'.$server_hostname.<span class="charliteral">'\'</span>)');
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510     $this-&gt;_server['hostname'] = $server_hostname;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="comment">//check port</span>
<a name="l00513"></a>00513     <span class="keywordflow">if</span> ( $server_port == 0 
<a name="l00514"></a>00514         || !is_int($server_port) ) {
<a name="l00515"></a>00515       <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('bad CAS server port (`'.$server_hostname.<span class="charliteral">'\'</span>)');
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     $this-&gt;_server['port'] = $server_port;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     <span class="comment">//check URI</span>
<a name="l00520"></a>00520     <span class="keywordflow">if</span> ( !preg_match('/[\.\d\-_abcdefghijklmnopqrstuvwxyz\/]*/',$server_uri) ) {
<a name="l00521"></a>00521       <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('bad CAS server URI (`'.$server_uri.<span class="charliteral">'\'</span>)');
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523     <span class="comment">//add leading and trailing `/' and remove doubles      </span>
<a name="l00524"></a>00524     $server_uri = preg_replace('/\/\<span class="comment">//','/','/'.$server_uri.'/');</span>
<a name="l00525"></a>00525     $this-&gt;_server['uri'] = $server_uri;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">//set to callback mode if PgtIou and PgtId CGI GET parameters are provided </span>
<a name="l00528"></a>00528     <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l00529"></a>00529       $this-&gt;<a class="code" href="group__internalCallback.html#g32355da8dec2de8de0b8bd3a29f8b041">setCallbackMode</a>(!empty($_GET['pgtIou'])&amp;&amp;!empty($_GET['pgtId']));
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalCallback.html#gc5e4db434f458b4ec1c591d475ddef53">isCallbackMode</a>() ) {
<a name="l00533"></a>00533       <span class="comment">//callback mode: check that phpCAS is secured</span>
<a name="l00534"></a>00534       <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() ) {
<a name="l00535"></a>00535         <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('CAS proxies must be secured to use <a class="code" href="classphpCAS.html">phpCAS</a>; PGT\'s will not be received from the CAS server');
<a name="l00536"></a>00536       }
<a name="l00537"></a>00537     } <span class="keywordflow">else</span> {
<a name="l00538"></a>00538       <span class="comment">//normal mode: get ticket and remove it from CGI parameters for developpers</span>
<a name="l00539"></a>00539       $ticket = (isset($_GET['ticket']) ? $_GET['ticket'] : null);
<a name="l00540"></a>00540       <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l00541"></a>00541         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>: <span class="comment">// check for a Service Ticket</span>
<a name="l00542"></a>00542           <span class="keywordflow">if</span>( preg_match('/^ST-/',$ticket) ) {
<a name="l00543"></a>00543             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ST \''.$ticket.<span class="charliteral">'\'</span> found');
<a name="l00544"></a>00544             <span class="comment">//ST present</span>
<a name="l00545"></a>00545             $this-&gt;<a class="code" href="group__internalBasic.html#gca73a8a7c4adb1175c4ba0e3812979db">setST</a>($ticket);
<a name="l00546"></a>00546             <span class="comment">//ticket has been taken into account, unset it to hide it to applications</span>
<a name="l00547"></a>00547             unset($_GET['ticket']);
<a name="l00548"></a>00548           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !empty($ticket) ) {
<a name="l00549"></a>00549             <span class="comment">//ill-formed ticket, halt</span>
<a name="l00550"></a>00550             <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('ill-formed ticket found in the URL (ticket=`'.htmlentities($ticket).<span class="charliteral">'\'</span>)');
<a name="l00551"></a>00551           }
<a name="l00552"></a>00552           <span class="keywordflow">break</span>;
<a name="l00553"></a>00553         <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>: <span class="comment">// check for a Service or Proxy Ticket</span>
<a name="l00554"></a>00554           <span class="keywordflow">if</span>( preg_match('/^[SP]T-/',$ticket) ) {
<a name="l00555"></a>00555             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ST or PT \''.$ticket.<span class="charliteral">'\'</span> found');
<a name="l00556"></a>00556             $this-&gt;<a class="code" href="group__internalProxied.html#g23e26824081b516fcbe856f459249956">setPT</a>($ticket);
<a name="l00557"></a>00557             unset($_GET['ticket']);
<a name="l00558"></a>00558           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !empty($ticket) ) {
<a name="l00559"></a>00559             <span class="comment">//ill-formed ticket, halt</span>
<a name="l00560"></a>00560             <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('ill-formed ticket found in the URL (ticket=`'.htmlentities($ticket).<span class="charliteral">'\'</span>)');
<a name="l00561"></a>00561           } 
<a name="l00562"></a>00562           <span class="keywordflow">break</span>;
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565     <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>();
<a name="l00566"></a>00566   }
<a name="l00567"></a>00567 
<a name="l00570"></a>00570   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00571"></a>00571   <span class="comment">// XX                                                                    XX</span>
<a name="l00572"></a>00572   <span class="comment">// XX                           AUTHENTICATION                           XX</span>
<a name="l00573"></a>00573   <span class="comment">// XX                                                                    XX</span>
<a name="l00574"></a>00574   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00575"></a>00575 
<a name="l00588"></a><a class="code" href="group__internalAuthentication.html#g88717b5779f2555ba9375e35e37635d2">00588</a>   var <a class="code" href="group__internalAuthentication.html#g88717b5779f2555ba9375e35e37635d2">$_user</a> = '';
<a name="l00589"></a>00589   
<a name="l00597"></a><a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">00597</a>   function <a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>($user)
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599       $this-&gt;_user = $user;
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601 
<a name="l00609"></a><a class="code" href="group__internalAuthentication.html#gb3ffd6b93090db528cf062a65ac37cfc">00609</a>   function <a class="code" href="group__internalAuthentication.html#gb3ffd6b93090db528cf062a65ac37cfc">getUser</a>()
<a name="l00610"></a>00610     {
<a name="l00611"></a>00611       <span class="keywordflow">if</span> ( empty($this-&gt;_user) ) {
<a name="l00612"></a>00612         <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('<span class="keyword">this</span> method should be used only after '.__CLASS__.'::<a class="code" href="group__internalAuthentication.html#gb947846496cb49145ba7e7ee477f04db">forceAuthentication</a>() or '.__CLASS__.'::<a class="code" href="group__internalAuthentication.html#g8d474263083c513b38e959293e9b731e">isAuthenticated</a>()');
<a name="l00613"></a>00613       }
<a name="l00614"></a>00614       <span class="keywordflow">return</span> $this-&gt;_user;
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00623"></a><a class="code" href="group__internalAuthentication.html#gb947846496cb49145ba7e7ee477f04db">00623</a>   function <a class="code" href="group__internalAuthentication.html#gb947846496cb49145ba7e7ee477f04db">forceAuthentication</a>()
<a name="l00624"></a>00624     {
<a name="l00625"></a>00625       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00626"></a>00626 
<a name="l00627"></a>00627       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#g8d474263083c513b38e959293e9b731e">isAuthenticated</a>() ) {
<a name="l00628"></a>00628         <span class="comment">// the user is authenticated, nothing to be done.</span>
<a name="l00629"></a>00629             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('no need to authenticate');
<a name="l00630"></a>00630             $res = TRUE;
<a name="l00631"></a>00631       } <span class="keywordflow">else</span> {
<a name="l00632"></a>00632             <span class="comment">// the user is not authenticated, redirect to the CAS server</span>
<a name="l00633"></a>00633         unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked']);
<a name="l00634"></a>00634             $this-&gt;<a class="code" href="group__internalAuthentication.html#gaa8456b830d473d0e9b994a01160125a">redirectToCas</a>(FALSE<span class="comment">/* no gateway */</span>);        
<a name="l00635"></a>00635             <span class="comment">// never reached</span>
<a name="l00636"></a>00636             $res = FALSE;
<a name="l00637"></a>00637       }
<a name="l00638"></a>00638       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($res);
<a name="l00639"></a>00639       <span class="keywordflow">return</span> $res;
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641 
<a name="l00648"></a><a class="code" href="group__internalAuthentication.html#gdf79f4ad7e8c7d0e641eba3b92a697ec">00648</a>   var <a class="code" href="group__internalAuthentication.html#gdf79f4ad7e8c7d0e641eba3b92a697ec">$_cache_times_for_auth_recheck</a> = 0;
<a name="l00649"></a>00649   
<a name="l00657"></a><a class="code" href="group__internalAuthentication.html#gc8f1dde656e52bab37595af51843ca54">00657</a>   function <a class="code" href="group__internalAuthentication.html#gc8f1dde656e52bab37595af51843ca54">setCacheTimesForAuthRequest</a>($n)
<a name="l00658"></a>00658     {
<a name="l00659"></a>00659       $this-&gt;_cache_times_for_auth_recheck = n;
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661 
<a name="l00667"></a><a class="code" href="group__internalAuthentication.html#g093a3e248675ab5db97efe2668707947">00667</a>   function <a class="code" href="group__internalAuthentication.html#g093a3e248675ab5db97efe2668707947">checkAuthentication</a>()
<a name="l00668"></a>00668     {
<a name="l00669"></a>00669       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00670"></a>00670 
<a name="l00671"></a>00671       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#g8d474263083c513b38e959293e9b731e">isAuthenticated</a>() ) {
<a name="l00672"></a>00672             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user is authenticated');
<a name="l00673"></a>00673             $res = TRUE;
<a name="l00674"></a>00674       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'])) {
<a name="l00675"></a>00675         <span class="comment">// the previous request has redirected the client to the CAS server with gateway=true</span>
<a name="l00676"></a>00676         unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked']);
<a name="l00677"></a>00677         $res = FALSE;
<a name="l00678"></a>00678       } <span class="keywordflow">else</span> {
<a name="l00679"></a>00679 <span class="comment">//        $_SESSION['phpCAS']['auth_checked'] = true;</span>
<a name="l00680"></a>00680 <span class="comment">//          $this-&gt;redirectToCas(TRUE/* gateway */);    </span>
<a name="l00681"></a>00681 <span class="comment">//          // never reached</span>
<a name="l00682"></a>00682 <span class="comment">//          $res = FALSE;</span>
<a name="l00683"></a>00683         <span class="comment">// avoid a check against CAS on every request</span>
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (! isset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count']) )
<a name="l00685"></a>00685            $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] = -2; <span class="comment">// uninitialized</span>
<a name="l00686"></a>00686         
<a name="l00687"></a>00687         <span class="keywordflow">if</span> (($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] != -2 &amp;&amp; $this-&gt;_cache_times_for_auth_recheck == -1) 
<a name="l00688"></a>00688           || ($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] &gt;= 0 &amp;&amp; $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] &lt; $this-&gt;_cache_times_for_auth_recheck))
<a name="l00689"></a>00689         {
<a name="l00690"></a>00690            $res = FALSE;
<a name="l00691"></a>00691            
<a name="l00692"></a>00692            <span class="keywordflow">if</span> ($this-&gt;_cache_times_for_auth_recheck != -1)
<a name="l00693"></a>00693            {
<a name="l00694"></a>00694                           $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count']++;
<a name="l00695"></a>00695                   <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user is not authenticated (cached <span class="keywordflow">for</span> '.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'].' times of '.$this-&gt;_cache_times_for_auth_recheck.<span class="charliteral">')'</span>);
<a name="l00696"></a>00696            }
<a name="l00697"></a>00697            <span class="keywordflow">else</span>
<a name="l00698"></a>00698            {
<a name="l00699"></a>00699                   <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user is not authenticated (cached <span class="keywordflow">for</span> until login pressed)');
<a name="l00700"></a>00700            }
<a name="l00701"></a>00701         }
<a name="l00702"></a>00702         <span class="keywordflow">else</span>
<a name="l00703"></a>00703         {
<a name="l00704"></a>00704                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['unauth_count'] = 0;
<a name="l00705"></a>00705             $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['auth_checked'] = <span class="keyword">true</span>;
<a name="l00706"></a>00706             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user is not authenticated (cache reset)');
<a name="l00707"></a>00707             $this-&gt;<a class="code" href="group__internalAuthentication.html#gaa8456b830d473d0e9b994a01160125a">redirectToCas</a>(TRUE<span class="comment">/* gateway */</span>);    
<a name="l00708"></a>00708             <span class="comment">// never reached</span>
<a name="l00709"></a>00709             $res = FALSE;
<a name="l00710"></a>00710         }
<a name="l00711"></a>00711       }
<a name="l00712"></a>00712       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($res);
<a name="l00713"></a>00713       <span class="keywordflow">return</span> $res;
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715   
<a name="l00724"></a><a class="code" href="group__internalAuthentication.html#g8d474263083c513b38e959293e9b731e">00724</a>   function <a class="code" href="group__internalAuthentication.html#g8d474263083c513b38e959293e9b731e">isAuthenticated</a>()
<a name="l00725"></a>00725   {
<a name="l00726"></a>00726       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00727"></a>00727       $res = FALSE;
<a name="l00728"></a>00728       $validate_url = '';
<a name="l00729"></a>00729 
<a name="l00730"></a>00730       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#gfbdcb947be02bbd290980282c40d276d">wasPreviouslyAuthenticated</a>() ) {
<a name="l00731"></a>00731                  <span class="comment">// the user has already (previously during the session) been </span>
<a name="l00732"></a>00732                  <span class="comment">// authenticated, nothing to be done.</span>
<a name="l00733"></a>00733         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user was already authenticated, no need to look <span class="keywordflow">for</span> tickets');
<a name="l00734"></a>00734         $res = TRUE;
<a name="l00735"></a>00735       } 
<a name="l00736"></a>00736           elseif ( $this-&gt;<a class="code" href="group__internalBasic.html#g76f2832ba150597409e47421aaaaa35e">hasST</a>() ) {
<a name="l00737"></a>00737         <span class="comment">// if a Service Ticket was given, validate it</span>
<a name="l00738"></a>00738         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ST `'.$this-&gt;<a class="code" href="group__internalBasic.html#gcc7692242bf95b8429d704de40a6cd52">getST</a>().<span class="charliteral">'\'</span> is present');
<a name="l00739"></a>00739         $this-&gt;<a class="code" href="group__internalBasic.html#gcf3f1b530d4e029b3124558cc74d56cb">validateST</a>($validate_url,$text_response,$tree_response); <span class="comment">// if it fails, it halts</span>
<a name="l00740"></a>00740         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ST `'.$this-&gt;<a class="code" href="group__internalBasic.html#gcc7692242bf95b8429d704de40a6cd52">getST</a>().<span class="charliteral">'\'</span> was validated');
<a name="l00741"></a>00741         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l00742"></a>00742                    $this-&gt;<a class="code" href="group__internalPGTStorage.html#gff6d96062187548ffba93dd7edbca563">validatePGT</a>($validate_url,$text_response,$tree_response); <span class="comment">// idem</span>
<a name="l00743"></a>00743                    <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PGT `'.$this-&gt;<a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">getPGT</a>().<span class="charliteral">'\'</span> was validated');
<a name="l00744"></a>00744                    $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'] = $this-&gt;<a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">getPGT</a>();
<a name="l00745"></a>00745                 }
<a name="l00746"></a>00746                 $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'] = $this-&gt;<a class="code" href="group__internalAuthentication.html#gb3ffd6b93090db528cf062a65ac37cfc">getUser</a>();
<a name="l00747"></a>00747                 $res = TRUE;
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749         elseif ( $this-&gt;<a class="code" href="group__internalProxied.html#g72ebeda5e6c9dbaac0e1e20a9e6419e4">hasPT</a>() ) {
<a name="l00750"></a>00750                 <span class="comment">// if a Proxy Ticket was given, validate it</span>
<a name="l00751"></a>00751                 <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PT `'.$this-&gt;<a class="code" href="group__internalProxied.html#gf916fb31175e9dd4b8f383f6f6085982">getPT</a>().<span class="charliteral">'\'</span> is present');
<a name="l00752"></a>00752                 $this-&gt;<a class="code" href="group__internalProxied.html#g59ed21e8f3d40c8f33d277ca7ea3224f">validatePT</a>($validate_url,$text_response,$tree_response); <span class="comment">// note: if it fails, it halts</span>
<a name="l00753"></a>00753                 <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PT `'.$this-&gt;<a class="code" href="group__internalProxied.html#gf916fb31175e9dd4b8f383f6f6085982">getPT</a>().<span class="charliteral">'\'</span> was validated');
<a name="l00754"></a>00754                 <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l00755"></a>00755                    $this-&gt;<a class="code" href="group__internalPGTStorage.html#gff6d96062187548ffba93dd7edbca563">validatePGT</a>($validate_url,$text_response,$tree_response); <span class="comment">// idem</span>
<a name="l00756"></a>00756                    <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PGT `'.$this-&gt;<a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">getPGT</a>().<span class="charliteral">'\'</span> was validated');
<a name="l00757"></a>00757                    $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'] = $this-&gt;<a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">getPGT</a>();
<a name="l00758"></a>00758                 }
<a name="l00759"></a>00759         $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'] = $this-&gt;<a class="code" href="group__internalAuthentication.html#gb3ffd6b93090db528cf062a65ac37cfc">getUser</a>();
<a name="l00760"></a>00760                 $res = TRUE;
<a name="l00761"></a>00761         } 
<a name="l00762"></a>00762         <span class="keywordflow">else</span> {
<a name="l00763"></a>00763         <span class="comment">// no ticket given, not authenticated</span>
<a name="l00764"></a>00764         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('no ticket found');
<a name="l00765"></a>00765         }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($res);
<a name="l00768"></a>00768         <span class="keywordflow">return</span> $res;
<a name="l00769"></a>00769   }
<a name="l00770"></a>00770   
<a name="l00776"></a><a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">00776</a>   function <a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">isSessionAuthenticated</a> ()
<a name="l00777"></a>00777     {
<a name="l00778"></a>00778       <span class="keywordflow">return</span> !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780 
<a name="l00791"></a><a class="code" href="group__internalAuthentication.html#gfbdcb947be02bbd290980282c40d276d">00791</a>   function <a class="code" href="group__internalAuthentication.html#gfbdcb947be02bbd290980282c40d276d">wasPreviouslyAuthenticated</a>()
<a name="l00792"></a>00792     {
<a name="l00793"></a>00793       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00794"></a>00794 
<a name="l00795"></a>00795       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalCallback.html#gc5e4db434f458b4ec1c591d475ddef53">isCallbackMode</a>() ) {
<a name="l00796"></a>00796         $this-&gt;<a class="code" href="group__internalCallback.html#gd97c1a5034db62dae9ac03062539b1cc">callback</a>();
<a name="l00797"></a>00797       }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       $auth = FALSE;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l00802"></a>00802         <span class="comment">// CAS proxy: username and PGT must be present</span>
<a name="l00803"></a>00803         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">isSessionAuthenticated</a>() &amp;&amp; !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
<a name="l00804"></a>00804           <span class="comment">// authentication already done</span>
<a name="l00805"></a>00805           $this-&gt;<a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
<a name="l00806"></a>00806           $this-&gt;<a class="code" href="group__internalProxy.html#geccecf5dc011daf09720c1acf4380f63">setPGT</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']);
<a name="l00807"></a>00807           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\'</span>, PGT = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'].<span class="charliteral">'\''</span>); 
<a name="l00808"></a>00808           $auth = TRUE;
<a name="l00809"></a>00809         } elseif ( $this-&gt;<a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">isSessionAuthenticated</a>() &amp;&amp; empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
<a name="l00810"></a>00810           <span class="comment">// these two variables should be empty or not empty at the same time</span>
<a name="l00811"></a>00811           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('username found (`'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\'</span>) but PGT is empty');
<a name="l00812"></a>00812           <span class="comment">// unset all tickets to enforce authentication</span>
<a name="l00813"></a>00813           unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']);
<a name="l00814"></a>00814           $this-&gt;<a class="code" href="group__internalBasic.html#gca73a8a7c4adb1175c4ba0e3812979db">setST</a>('');
<a name="l00815"></a>00815           $this-&gt;<a class="code" href="group__internalProxied.html#g23e26824081b516fcbe856f459249956">setPT</a>('');
<a name="l00816"></a>00816         } elseif ( !$this-&gt;<a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">isSessionAuthenticated</a>() &amp;&amp; !empty($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt']) ) {
<a name="l00817"></a>00817           <span class="comment">// these two variables should be empty or not empty at the same time</span>
<a name="l00818"></a>00818           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PGT found (`'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['pgt'].<span class="charliteral">'\'</span>) but username is empty'); 
<a name="l00819"></a>00819           <span class="comment">// unset all tickets to enforce authentication</span>
<a name="l00820"></a>00820           unset($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']);
<a name="l00821"></a>00821           $this-&gt;<a class="code" href="group__internalBasic.html#gca73a8a7c4adb1175c4ba0e3812979db">setST</a>('');
<a name="l00822"></a>00822           $this-&gt;<a class="code" href="group__internalProxied.html#g23e26824081b516fcbe856f459249956">setPT</a>('');
<a name="l00823"></a>00823         } <span class="keywordflow">else</span> {
<a name="l00824"></a>00824           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('neither user not PGT found'); 
<a name="l00825"></a>00825         }
<a name="l00826"></a>00826       } <span class="keywordflow">else</span> {
<a name="l00827"></a>00827         <span class="comment">// `simple' CAS client (not a proxy): username must be present</span>
<a name="l00828"></a>00828         <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalAuthentication.html#g473da5bed5067e4ada55ed067ab06eab">isSessionAuthenticated</a>() ) {
<a name="l00829"></a>00829           <span class="comment">// authentication already done</span>
<a name="l00830"></a>00830           $this-&gt;<a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user']);
<a name="l00831"></a>00831           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user = `'.$_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['user'].<span class="charliteral">'\''</span>); 
<a name="l00832"></a>00832           $auth = TRUE;
<a name="l00833"></a>00833         } <span class="keywordflow">else</span> {
<a name="l00834"></a>00834           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('no user found');
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836       }
<a name="l00837"></a>00837       
<a name="l00838"></a>00838       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($auth);
<a name="l00839"></a>00839       <span class="keywordflow">return</span> $auth;
<a name="l00840"></a>00840     }
<a name="l00841"></a>00841   
<a name="l00848"></a><a class="code" href="group__internalAuthentication.html#gaa8456b830d473d0e9b994a01160125a">00848</a>   function <a class="code" href="group__internalAuthentication.html#gaa8456b830d473d0e9b994a01160125a">redirectToCas</a>($gateway=<span class="keyword">false</span>)
<a name="l00849"></a>00849     {
<a name="l00850"></a>00850       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00851"></a>00851       $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#g9f61cf3e3f245ac17836fa52d9c17e5b">getServerLoginURL</a>($gateway);
<a name="l00852"></a>00852       header('Location: '.$cas_url);
<a name="l00853"></a>00853       $this-&gt;<a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">printHTMLHeader</a>($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#999b1717ee6dd2a0dac03e37c934761d">CAS_STR_AUTHENTICATION_WANTED</a>));
<a name="l00854"></a>00854       printf('&lt;p&gt;'.$this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#fe67c82a8a48d757da2d1953885cce74">CAS_STR_SHOULD_HAVE_BEEN_REDIRECTED</a>).'&lt;/p&gt;',$cas_url);
<a name="l00855"></a>00855       $this-&gt;<a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">printHTMLFooter</a>();
<a name="l00856"></a>00856       <a class="code" href="group__internalDebug.html#g38887ed1896e7ba9f0e440a3d8ef17ae">phpCAS::traceExit</a>();
<a name="l00857"></a>00857       exit();
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859   
<a name="l00865"></a><a class="code" href="group__internalAuthentication.html#g73c09d652b42b06ca1da800d6fa4660e">00865</a>   function <a class="code" href="group__internalAuthentication.html#g73c09d652b42b06ca1da800d6fa4660e">logout</a>($url = <span class="stringliteral">""</span>)
<a name="l00866"></a>00866     {
<a name="l00867"></a>00867       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00868"></a>00868       $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#ge5b55ff9a82586d2b85181de1e4dba78">getServerLogoutURL</a>();
<a name="l00869"></a>00869       <span class="comment">// v0.4.14 sebastien.gougeon at univ-rennes1.fr</span>
<a name="l00870"></a>00870       <span class="comment">// header('Location: '.$cas_url);</span>
<a name="l00871"></a>00871       <span class="keywordflow">if</span> ( $url != <span class="stringliteral">""</span> ) {
<a name="l00872"></a>00872         $url = '?service=' . $url;
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874       header('Location: '.$cas_url . $url);
<a name="l00875"></a>00875       session_unset();
<a name="l00876"></a>00876       session_destroy();
<a name="l00877"></a>00877       $this-&gt;<a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">printHTMLHeader</a>($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#13b03baa656e8d87381b940fd861a991">CAS_STR_LOGOUT</a>));
<a name="l00878"></a>00878       printf('&lt;p&gt;'.$this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#fe67c82a8a48d757da2d1953885cce74">CAS_STR_SHOULD_HAVE_BEEN_REDIRECTED</a>).'&lt;/p&gt;',$cas_url);
<a name="l00879"></a>00879       $this-&gt;<a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">printHTMLFooter</a>();
<a name="l00880"></a>00880       <a class="code" href="group__internalDebug.html#g38887ed1896e7ba9f0e440a3d8ef17ae">phpCAS::traceExit</a>();
<a name="l00881"></a>00881       exit();
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883   
<a name="l00886"></a>00886   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00887"></a>00887   <span class="comment">// XX                                                                    XX</span>
<a name="l00888"></a>00888   <span class="comment">// XX                  BASIC CLIENT FEATURES (CAS 1.0)                   XX</span>
<a name="l00889"></a>00889   <span class="comment">// XX                                                                    XX</span>
<a name="l00890"></a>00890   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892   <span class="comment">// ########################################################################</span>
<a name="l00893"></a>00893   <span class="comment">//  ST</span>
<a name="l00894"></a>00894   <span class="comment">// ########################################################################</span>
<a name="l00908"></a><a class="code" href="group__internalBasic.html#gd790c032504597c075875197f64cc73b">00908</a> <span class="comment"></span>  var <a class="code" href="group__internalBasic.html#gd790c032504597c075875197f64cc73b">$_st</a> = '';
<a name="l00909"></a>00909   
<a name="l00915"></a><a class="code" href="group__internalBasic.html#gcc7692242bf95b8429d704de40a6cd52">00915</a>   function <a class="code" href="group__internalBasic.html#gcc7692242bf95b8429d704de40a6cd52">getST</a>()
<a name="l00916"></a>00916     { <span class="keywordflow">return</span> $this-&gt;_st; }
<a name="l00917"></a>00917 
<a name="l00923"></a><a class="code" href="group__internalBasic.html#gca73a8a7c4adb1175c4ba0e3812979db">00923</a>   function <a class="code" href="group__internalBasic.html#gca73a8a7c4adb1175c4ba0e3812979db">setST</a>($st)
<a name="l00924"></a>00924     { $this-&gt;_st = $st; }
<a name="l00925"></a>00925 
<a name="l00931"></a><a class="code" href="group__internalBasic.html#g76f2832ba150597409e47421aaaaa35e">00931</a>   function <a class="code" href="group__internalBasic.html#g76f2832ba150597409e47421aaaaa35e">hasST</a>()
<a name="l00932"></a>00932     { <span class="keywordflow">return</span> !empty($this-&gt;_st); }
<a name="l00933"></a>00933 
<a name="l00936"></a>00936   <span class="comment">// ########################################################################</span>
<a name="l00937"></a>00937   <span class="comment">//  ST VALIDATION</span>
<a name="l00938"></a>00938   <span class="comment">// ########################################################################</span>
<a name="l00957"></a><a class="code" href="group__internalBasic.html#gcf3f1b530d4e029b3124558cc74d56cb">00957</a> <span class="comment"></span>  function <a class="code" href="group__internalBasic.html#gcf3f1b530d4e029b3124558cc74d56cb">validateST</a>($validate_url,&amp;$text_response,&amp;$tree_response)
<a name="l00958"></a>00958     {
<a name="l00959"></a>00959       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l00960"></a>00960       <span class="comment">// build the URL to validate the ticket</span>
<a name="l00961"></a>00961       $validate_url = $this-&gt;<a class="code" href="group__internalConfig.html#g9bbd5b923772625ee3fc23ef07a641d3">getServerServiceValidateURL</a>().'&amp;ticket='.$this-&gt;getST();
<a name="l00962"></a>00962       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l00963"></a>00963                  <span class="comment">// pass the callback url for CAS proxies</span>
<a name="l00964"></a>00964                  $validate_url .= '&amp;pgtUrl='.$this-&gt;getCallbackURL();
<a name="l00965"></a>00965       }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967       <span class="comment">// open and read the URL</span>
<a name="l00968"></a>00968       <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">readURL</a>($validate_url,''<span class="comment">/*cookies*/</span>,$headers,$text_response,$err_msg) ) {
<a name="l00969"></a>00969         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not open URL \''.$validate_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
<a name="l00970"></a>00970         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l00971"></a>00971                          $validate_url,
<a name="l00972"></a>00972                          TRUE<span class="comment">/*$no_response*/</span>);
<a name="l00973"></a>00973       }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975       <span class="comment">// analyze the result depending on the version</span>
<a name="l00976"></a>00976       <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l00977"></a>00977       <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l00978"></a>00978         <span class="keywordflow">if</span> (preg_match('/^no\n/',$text_response)) {
<a name="l00979"></a>00979           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ST has not been validated');
<a name="l00980"></a>00980           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l00981"></a>00981                        $validate_url,
<a name="l00982"></a>00982                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l00983"></a>00983                        FALSE<span class="comment">/*$bad_response*/</span>,
<a name="l00984"></a>00984                        $text_response);
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (!preg_match('/^yes\n/',$text_response)) {
<a name="l00987"></a>00987           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ill-formed response');
<a name="l00988"></a>00988           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l00989"></a>00989                        $validate_url,
<a name="l00990"></a>00990                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l00991"></a>00991                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l00992"></a>00992                        $text_response);
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994         <span class="comment">// ST has been validated, extract the user name</span>
<a name="l00995"></a>00995         $arr = preg_split('/\n/',$text_response);
<a name="l00996"></a>00996         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>(trim($arr[1]));
<a name="l00997"></a>00997         <span class="keywordflow">break</span>;
<a name="l00998"></a>00998       <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l00999"></a>00999         <span class="comment">// read the response of the CAS server into a DOM object</span>
<a name="l01000"></a>01000         <span class="keywordflow">if</span> ( !($dom = <a class="code" href="domxml-php4-php5_8php.html#3842a4a076220606c7c5fe2e84eccdf7">domxml_open_mem</a>($text_response))) {
<a name="l01001"></a>01001           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('<a class="code" href="domxml-php4-php5_8php.html#3842a4a076220606c7c5fe2e84eccdf7">domxml_open_mem</a>() failed');
<a name="l01002"></a>01002           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01003"></a>01003                        $validate_url,
<a name="l01004"></a>01004                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01005"></a>01005                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01006"></a>01006                        $text_response);
<a name="l01007"></a>01007         }
<a name="l01008"></a>01008         <span class="comment">// read the root node of the XML tree</span>
<a name="l01009"></a>01009         <span class="keywordflow">if</span> ( !($tree_response = $dom-&gt;document_element()) ) {
<a name="l01010"></a>01010           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('document_element() failed');
<a name="l01011"></a>01011           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01012"></a>01012                        $validate_url,
<a name="l01013"></a>01013                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01014"></a>01014                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01015"></a>01015                        $text_response);
<a name="l01016"></a>01016         }
<a name="l01017"></a>01017         <span class="comment">// insure that tag name is 'serviceResponse'</span>
<a name="l01018"></a>01018         <span class="keywordflow">if</span> ( $tree_response-&gt;node_name() != 'serviceResponse' ) {
<a name="l01019"></a>01019           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('bad XML root node (should be `serviceResponse\' instead of `'.$tree_response-&gt;node_name().<span class="charliteral">'\''</span>);
<a name="l01020"></a>01020           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01021"></a>01021                        $validate_url,
<a name="l01022"></a>01022                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01023"></a>01023                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01024"></a>01024                        $text_response);
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($success_elements = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationSuccess"</span>)) != 0) {
<a name="l01027"></a>01027           <span class="comment">// authentication succeded, extract the user name</span>
<a name="l01028"></a>01028           <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($user_elements = $success_elements[0]-&gt;get_elements_by_tagname(<span class="stringliteral">"user"</span>)) == 0) {
<a name="l01029"></a>01029             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('&lt;authenticationSuccess&gt; found, but no &lt;user&gt;');
<a name="l01030"></a>01030             $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01031"></a>01031                          $validate_url,
<a name="l01032"></a>01032                          FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01033"></a>01033                          TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01034"></a>01034                          $text_response);
<a name="l01035"></a>01035           }
<a name="l01036"></a>01036           $user = trim($user_elements[0]-&gt;get_content());
<a name="l01037"></a>01037           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('user = `'.$user);
<a name="l01038"></a>01038           $this-&gt;<a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>($user);
<a name="l01039"></a>01039           
<a name="l01040"></a>01040         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($failure_elements = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationFailure"</span>)) != 0) {
<a name="l01041"></a>01041           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('&lt;authenticationFailure&gt; found');
<a name="l01042"></a>01042           <span class="comment">// authentication failed, extract the error code and message</span>
<a name="l01043"></a>01043           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01044"></a>01044                        $validate_url,
<a name="l01045"></a>01045                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01046"></a>01046                        FALSE<span class="comment">/*$bad_response*/</span>,
<a name="l01047"></a>01047                        $text_response,
<a name="l01048"></a>01048                        $failure_elements[0]-&gt;get_attribute('code')<span class="comment">/*$err_code*/</span>,
<a name="l01049"></a>01049                        trim($failure_elements[0]-&gt;get_content())<span class="comment">/*$err_msg*/</span>);
<a name="l01050"></a>01050         } <span class="keywordflow">else</span> {
<a name="l01051"></a>01051           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('neither &lt;authenticationSuccess&gt; nor &lt;authenticationFailure&gt; found');
<a name="l01052"></a>01052           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('ST not validated',
<a name="l01053"></a>01053                        $validate_url,
<a name="l01054"></a>01054                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01055"></a>01055                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01056"></a>01056                        $text_response);
<a name="l01057"></a>01057         }
<a name="l01058"></a>01058         <span class="keywordflow">break</span>;
<a name="l01059"></a>01059       }
<a name="l01060"></a>01060       
<a name="l01061"></a>01061       <span class="comment">// at this step, ST has been validated and $this-&gt;_user has been set,</span>
<a name="l01062"></a>01062       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(TRUE);
<a name="l01063"></a>01063       <span class="keywordflow">return</span> TRUE;
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065 
<a name="l01068"></a>01068   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01069"></a>01069   <span class="comment">// XX                                                                    XX</span>
<a name="l01070"></a>01070   <span class="comment">// XX                     PROXY FEATURES (CAS 2.0)                       XX</span>
<a name="l01071"></a>01071   <span class="comment">// XX                                                                    XX</span>
<a name="l01072"></a>01072   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01073"></a>01073 
<a name="l01074"></a>01074   <span class="comment">// ########################################################################</span>
<a name="l01075"></a>01075   <span class="comment">//  PROXYING</span>
<a name="l01076"></a>01076   <span class="comment">// ########################################################################</span>
<a name="l01088"></a><a class="code" href="group__internalProxy.html#g3439bf6d03dccb2d1d4a44d7bf4d17b0">01088</a> <span class="comment"></span>  var <a class="code" href="group__internalProxy.html#g3439bf6d03dccb2d1d4a44d7bf4d17b0">$_proxy</a>;
<a name="l01089"></a>01089   
<a name="l01097"></a><a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">01097</a>   function <a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>()
<a name="l01098"></a>01098     {
<a name="l01099"></a>01099       <span class="keywordflow">return</span> $this-&gt;_proxy;
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101 
<a name="l01103"></a>01103   <span class="comment">// ########################################################################</span>
<a name="l01104"></a>01104   <span class="comment">//  PGT</span>
<a name="l01105"></a>01105   <span class="comment">// ########################################################################</span>
<a name="l01118"></a><a class="code" href="group__internalProxy.html#gd08b04a7a65b9a20096a23486b5d562a">01118</a> <span class="comment"></span>  var <a class="code" href="group__internalProxy.html#gd08b04a7a65b9a20096a23486b5d562a">$_pgt</a> = '';
<a name="l01119"></a>01119   
<a name="l01125"></a><a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">01125</a>   function <a class="code" href="group__internalProxy.html#gf4f57e87e57847f93ebac1acacc60f8a">getPGT</a>()
<a name="l01126"></a>01126     { <span class="keywordflow">return</span> $this-&gt;_pgt; }
<a name="l01127"></a>01127 
<a name="l01133"></a><a class="code" href="group__internalProxy.html#geccecf5dc011daf09720c1acf4380f63">01133</a>   function <a class="code" href="group__internalProxy.html#geccecf5dc011daf09720c1acf4380f63">setPGT</a>($pgt)
<a name="l01134"></a>01134     { $this-&gt;_pgt = $pgt; }
<a name="l01135"></a>01135 
<a name="l01141"></a><a class="code" href="group__internalProxy.html#g432d879c0441763b4c1c1582bf1bc44c">01141</a>   function <a class="code" href="group__internalProxy.html#g432d879c0441763b4c1c1582bf1bc44c">hasPGT</a>()
<a name="l01142"></a>01142     { <span class="keywordflow">return</span> !empty($this-&gt;_pgt); }
<a name="l01143"></a>01143 
<a name="l01146"></a>01146   <span class="comment">// ########################################################################</span>
<a name="l01147"></a>01147   <span class="comment">//  CALLBACK MODE</span>
<a name="l01148"></a>01148   <span class="comment">// ########################################################################</span>
<a name="l01166"></a><a class="code" href="group__internalCallback.html#ge5f9e206e91e344b3b916e7b3d8cfdf4">01166</a> <span class="comment"></span>  var <a class="code" href="group__internalCallback.html#ge5f9e206e91e344b3b916e7b3d8cfdf4">$_callback_mode</a> = FALSE;
<a name="l01167"></a>01167   
<a name="l01175"></a><a class="code" href="group__internalCallback.html#g32355da8dec2de8de0b8bd3a29f8b041">01175</a>   function <a class="code" href="group__internalCallback.html#g32355da8dec2de8de0b8bd3a29f8b041">setCallbackMode</a>($callback_mode)
<a name="l01176"></a>01176     {
<a name="l01177"></a>01177       $this-&gt;_callback_mode = $callback_mode;
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 
<a name="l01188"></a><a class="code" href="group__internalCallback.html#gc5e4db434f458b4ec1c591d475ddef53">01188</a>   function <a class="code" href="group__internalCallback.html#gc5e4db434f458b4ec1c591d475ddef53">isCallbackMode</a>()
<a name="l01189"></a>01189     {
<a name="l01190"></a>01190       <span class="keywordflow">return</span> $this-&gt;_callback_mode;
<a name="l01191"></a>01191     }
<a name="l01192"></a>01192 
<a name="l01201"></a><a class="code" href="group__internalCallback.html#g5aec2b53fa9780b162c609c40cd93069">01201</a>   var <a class="code" href="group__internalCallback.html#g5aec2b53fa9780b162c609c40cd93069">$_callback_url</a> = '';
<a name="l01202"></a>01202 
<a name="l01212"></a><a class="code" href="group__internalCallback.html#g09ffc75739bdcb7dff15c16faafd07c9">01212</a>   function <a class="code" href="group__internalCallback.html#g09ffc75739bdcb7dff15c16faafd07c9">getCallbackURL</a>()
<a name="l01213"></a>01213     {
<a name="l01214"></a>01214       <span class="comment">// the URL is built when needed only</span>
<a name="l01215"></a>01215       <span class="keywordflow">if</span> ( empty($this-&gt;_callback_url) ) {
<a name="l01216"></a>01216         $final_uri = '';
<a name="l01217"></a>01217             <span class="comment">// remove the ticket if present in the URL</span>
<a name="l01218"></a>01218             $final_uri = 'https:<span class="comment">//';</span>
<a name="l01219"></a>01219             <span class="comment">/* replaced by Julien Marchal - v0.4.6</span>
<a name="l01220"></a>01220 <span class="comment">             * $this-&gt;uri .= $_SERVER['SERVER_NAME'];</span>
<a name="l01221"></a>01221 <span class="comment">             */</span>
<a name="l01222"></a>01222         <span class="keywordflow">if</span>(empty($_SERVER['HTTP_X_FORWARDED_SERVER'])){
<a name="l01223"></a>01223           <span class="comment">/* replaced by teedog - v0.4.12</span>
<a name="l01224"></a>01224 <span class="comment">           * $final_uri .= $_SERVER['SERVER_NAME'];</span>
<a name="l01225"></a>01225 <span class="comment">           */</span>
<a name="l01226"></a>01226           <span class="keywordflow">if</span> (empty($_SERVER['SERVER_NAME'])) {
<a name="l01227"></a>01227             $final_uri .= $_SERVER['HTTP_HOST'];
<a name="l01228"></a>01228           } <span class="keywordflow">else</span> {
<a name="l01229"></a>01229             $final_uri .= $_SERVER['SERVER_NAME'];
<a name="l01230"></a>01230           }
<a name="l01231"></a>01231         } <span class="keywordflow">else</span> {
<a name="l01232"></a>01232           $final_uri .= $_SERVER['HTTP_X_FORWARDED_SERVER'];
<a name="l01233"></a>01233         }
<a name="l01234"></a>01234             <span class="keywordflow">if</span> ( ($this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=443)
<a name="l01235"></a>01235                || (!$this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=80) ) {
<a name="l01236"></a>01236               $final_uri .= <span class="charliteral">':'</span>;
<a name="l01237"></a>01237               $final_uri .= $_SERVER['SERVER_PORT'];
<a name="l01238"></a>01238             }
<a name="l01239"></a>01239             $request_uri = $_SERVER['REQUEST_URI'];
<a name="l01240"></a>01240             $request_uri = preg_replace('/\?.*$/<span class="charliteral">','</span>',$request_uri);
<a name="l01241"></a>01241             $final_uri .= $request_uri;
<a name="l01242"></a>01242             $this-&gt;<a class="code" href="group__internalCallback.html#g78b8045da0dd166fae54f9850c8934de">setCallbackURL</a>($final_uri);
<a name="l01243"></a>01243       }
<a name="l01244"></a>01244       <span class="keywordflow">return</span> $this-&gt;_callback_url;
<a name="l01245"></a>01245     }
<a name="l01246"></a>01246 
<a name="l01254"></a><a class="code" href="group__internalCallback.html#g78b8045da0dd166fae54f9850c8934de">01254</a>   function <a class="code" href="group__internalCallback.html#g78b8045da0dd166fae54f9850c8934de">setCallbackURL</a>($url)
<a name="l01255"></a>01255     {
<a name="l01256"></a>01256       <span class="keywordflow">return</span> $this-&gt;_callback_url = $url;
<a name="l01257"></a>01257     }
<a name="l01258"></a>01258 
<a name="l01265"></a><a class="code" href="group__internalCallback.html#gd97c1a5034db62dae9ac03062539b1cc">01265</a>   function <a class="code" href="group__internalCallback.html#gd97c1a5034db62dae9ac03062539b1cc">callback</a>()
<a name="l01266"></a>01266     {
<a name="l01267"></a>01267       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01268"></a>01268       $this-&gt;<a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">printHTMLHeader</a>('<a class="code" href="classphpCAS.html">phpCAS</a> <a class="code" href="group__internalCallback.html#gd97c1a5034db62dae9ac03062539b1cc">callback</a>');
<a name="l01269"></a>01269       $pgt_iou = $_GET['pgtIou'];
<a name="l01270"></a>01270       $pgt = $_GET['pgtId'];
<a name="l01271"></a>01271       <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Storing PGT `'.$pgt.<span class="charliteral">'\'</span> (<span class="keywordtype">id</span>=`'.$pgt_iou.<span class="charliteral">'\'</span>)');
<a name="l01272"></a>01272       echo '&lt;p&gt;Storing PGT `'.$pgt.<span class="charliteral">'\'</span> (<span class="keywordtype">id</span>=`'.$pgt_iou.<span class="charliteral">'\'</span>).&lt;/p&gt;';
<a name="l01273"></a>01273       $this-&gt;<a class="code" href="group__internalPGTStorage.html#g3f1650d36cad4d7a70cb4b37b2a9b6b7">storePGT</a>($pgt,$pgt_iou);
<a name="l01274"></a>01274       $this-&gt;<a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">printHTMLFooter</a>();
<a name="l01275"></a>01275       <a class="code" href="group__internalDebug.html#g38887ed1896e7ba9f0e440a3d8ef17ae">phpCAS::traceExit</a>();
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 
<a name="l01280"></a>01280   <span class="comment">// ########################################################################</span>
<a name="l01281"></a>01281   <span class="comment">//  PGT STORAGE</span>
<a name="l01282"></a>01282   <span class="comment">// ########################################################################</span>
<a name="l01296"></a><a class="code" href="group__internalPGTStorage.html#gb6c9bdf5c43999a3b8b8e35036cb491d">01296</a> <span class="comment"></span>  var <a class="code" href="group__internalPGTStorage.html#gb6c9bdf5c43999a3b8b8e35036cb491d">$_pgt_storage</a> = null;
<a name="l01297"></a>01297 
<a name="l01304"></a><a class="code" href="group__internalPGTStorage.html#g322a10ebbb6c3ef2e0d114fa83171a8a">01304</a>   function <a class="code" href="group__internalPGTStorage.html#g322a10ebbb6c3ef2e0d114fa83171a8a">initPGTStorage</a>()
<a name="l01305"></a>01305     {
<a name="l01306"></a>01306       <span class="comment">// if no SetPGTStorageXxx() has been used, default to file</span>
<a name="l01307"></a>01307       <span class="keywordflow">if</span> ( !is_object($this-&gt;_pgt_storage) ) {
<a name="l01308"></a>01308         $this-&gt;<a class="code" href="group__internalPGTStorage.html#g24dbbca8c79e42dacd44d87b94df1336">setPGTStorageFile</a>();
<a name="l01309"></a>01309       }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311       <span class="comment">// initializes the storage</span>
<a name="l01312"></a>01312       $this-&gt;_pgt_storage-&gt;init();
<a name="l01313"></a>01313     }
<a name="l01314"></a>01314   
<a name="l01323"></a><a class="code" href="group__internalPGTStorage.html#g3f1650d36cad4d7a70cb4b37b2a9b6b7">01323</a>   function <a class="code" href="group__internalPGTStorage.html#g3f1650d36cad4d7a70cb4b37b2a9b6b7">storePGT</a>($pgt,$pgt_iou)
<a name="l01324"></a>01324     {
<a name="l01325"></a>01325       <span class="comment">// ensure that storage is initialized</span>
<a name="l01326"></a>01326       $this-&gt;<a class="code" href="group__internalPGTStorage.html#g322a10ebbb6c3ef2e0d114fa83171a8a">initPGTStorage</a>();
<a name="l01327"></a>01327       <span class="comment">// writes the PGT</span>
<a name="l01328"></a>01328       $this-&gt;_pgt_storage-&gt;write($pgt,$pgt_iou);
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330   
<a name="l01340"></a><a class="code" href="group__internalPGTStorage.html#g0226ea3ecb328552d11dec260b75e7af">01340</a>   function <a class="code" href="group__internalPGTStorage.html#g0226ea3ecb328552d11dec260b75e7af">loadPGT</a>($pgt_iou)
<a name="l01341"></a>01341     {
<a name="l01342"></a>01342       <span class="comment">// ensure that storage is initialized</span>
<a name="l01343"></a>01343       $this-&gt;<a class="code" href="group__internalPGTStorage.html#g322a10ebbb6c3ef2e0d114fa83171a8a">initPGTStorage</a>();
<a name="l01344"></a>01344       <span class="comment">// read the PGT</span>
<a name="l01345"></a>01345       <span class="keywordflow">return</span> $this-&gt;_pgt_storage-&gt;read($pgt_iou);
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347   
<a name="l01357"></a><a class="code" href="group__internalPGTStorage.html#g24dbbca8c79e42dacd44d87b94df1336">01357</a>   function <a class="code" href="group__internalPGTStorage.html#g24dbbca8c79e42dacd44d87b94df1336">setPGTStorageFile</a>($format='',
<a name="l01358"></a>01358                              $path='')
<a name="l01359"></a>01359     {
<a name="l01360"></a>01360       <span class="comment">// check that the storage has not already been set</span>
<a name="l01361"></a>01361       <span class="keywordflow">if</span> ( is_object($this-&gt;_pgt_storage) ) {
<a name="l01362"></a>01362         <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('PGT storage already defined');
<a name="l01363"></a>01363       }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365       <span class="comment">// create the storage object</span>
<a name="l01366"></a>01366       $this-&gt;_pgt_storage = &amp;<span class="keyword">new</span> <a class="code" href="classPGTStorageFile.html">PGTStorageFile</a>($this,$format,$path);
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368   
<a name="l01386"></a><a class="code" href="group__internalPGTStorage.html#g885e4e413e69098a3a514427cd5addb4">01386</a>   function <a class="code" href="group__internalPGTStorage.html#g885e4e413e69098a3a514427cd5addb4">setPGTStorageDB</a>($user,
<a name="l01387"></a>01387                            $password,
<a name="l01388"></a>01388                            $database_type,
<a name="l01389"></a>01389                            $hostname,
<a name="l01390"></a>01390                            $port,
<a name="l01391"></a>01391                            $database,
<a name="l01392"></a>01392                            $table)
<a name="l01393"></a>01393     {
<a name="l01394"></a>01394       <span class="comment">// check that the storage has not already been set</span>
<a name="l01395"></a>01395       <span class="keywordflow">if</span> ( is_object($this-&gt;_pgt_storage) ) {
<a name="l01396"></a>01396         <a class="code" href="group__internalDebug.html#g11258505b061aae4683a3717206c187c">phpCAS::error</a>('PGT storage already defined');
<a name="l01397"></a>01397       }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399       <span class="comment">// warn the user that he should use file storage...</span>
<a name="l01400"></a>01400       trigger_error('PGT storage into database is an experimental feature, use at your own risk',E_USER_WARNING);
<a name="l01401"></a>01401 
<a name="l01402"></a>01402       <span class="comment">// create the storage object</span>
<a name="l01403"></a>01403       $this-&gt;_pgt_storage = &amp; <span class="keyword">new</span> <a class="code" href="classPGTStorageDB.html">PGTStorageDB</a>($this,$user,$password,$database_type,$hostname,$port,$database,$table);
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405   
<a name="l01406"></a>01406   <span class="comment">// ########################################################################</span>
<a name="l01407"></a>01407   <span class="comment">//  PGT VALIDATION</span>
<a name="l01408"></a>01408   <span class="comment">// ########################################################################</span>
<a name="l01422"></a><a class="code" href="group__internalPGTStorage.html#gff6d96062187548ffba93dd7edbca563">01422</a> <span class="comment"></span>  function <a class="code" href="group__internalPGTStorage.html#gff6d96062187548ffba93dd7edbca563">validatePGT</a>(&amp;$validate_url,$text_response,$tree_response)
<a name="l01423"></a>01423     {
<a name="l01424"></a>01424       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01425"></a>01425       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyGrantingTicket"</span>)) == 0) {
<a name="l01426"></a>01426         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('&lt;proxyGrantingTicket&gt; not found');
<a name="l01427"></a>01427         <span class="comment">// authentication succeded, but no PGT Iou was transmitted</span>
<a name="l01428"></a>01428         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('Ticket validated but no PGT Iou transmitted',
<a name="l01429"></a>01429                      $validate_url,
<a name="l01430"></a>01430                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01431"></a>01431                      FALSE<span class="comment">/*$bad_response*/</span>,
<a name="l01432"></a>01432                      $text_response);
<a name="l01433"></a>01433       } <span class="keywordflow">else</span> {
<a name="l01434"></a>01434         <span class="comment">// PGT Iou transmitted, extract it</span>
<a name="l01435"></a>01435         $pgt_iou = trim($arr[0]-&gt;get_content());
<a name="l01436"></a>01436         $pgt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#g0226ea3ecb328552d11dec260b75e7af">loadPGT</a>($pgt_iou);
<a name="l01437"></a>01437         <span class="keywordflow">if</span> ( $pgt == FALSE ) {
<a name="l01438"></a>01438           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not load PGT');
<a name="l01439"></a>01439           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PGT Iou was transmitted but PGT could not be retrieved',
<a name="l01440"></a>01440                        $validate_url,
<a name="l01441"></a>01441                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01442"></a>01442                        FALSE<span class="comment">/*$bad_response*/</span>,
<a name="l01443"></a>01443                        $text_response);
<a name="l01444"></a>01444         }
<a name="l01445"></a>01445         $this-&gt;<a class="code" href="group__internalProxy.html#geccecf5dc011daf09720c1acf4380f63">setPGT</a>($pgt);
<a name="l01446"></a>01446       }
<a name="l01447"></a>01447       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(TRUE);
<a name="l01448"></a>01448       <span class="keywordflow">return</span> TRUE;
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451   <span class="comment">// ########################################################################</span>
<a name="l01452"></a>01452   <span class="comment">//  PGT VALIDATION</span>
<a name="l01453"></a>01453   <span class="comment">// ########################################################################</span>
<a name="l01454"></a>01454 
<a name="l01466"></a><a class="code" href="group__internalPGTStorage.html#g6653e51d995e8a13a2f758f93e7dc7a0">01466</a>   function <a class="code" href="group__internalPGTStorage.html#g6653e51d995e8a13a2f758f93e7dc7a0">retrievePT</a>($target_service,&amp;$err_code,&amp;$err_msg)
<a name="l01467"></a>01467     {
<a name="l01468"></a>01468       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01469"></a>01469 
<a name="l01470"></a>01470       <span class="comment">// by default, $err_msg is set empty and $pt to TRUE. On error, $pt is</span>
<a name="l01471"></a>01471       <span class="comment">// set to false and $err_msg to an error message. At the end, if $pt is FALSE </span>
<a name="l01472"></a>01472       <span class="comment">// and $error_msg is still empty, it is set to 'invalid response' (the most</span>
<a name="l01473"></a>01473       <span class="comment">// commonly encountered error).</span>
<a name="l01474"></a>01474       $err_msg = '';
<a name="l01475"></a>01475 
<a name="l01476"></a>01476       <span class="comment">// build the URL to retrieve the PT</span>
<a name="l01477"></a>01477 <span class="comment">//      $cas_url = $this-&gt;getServerProxyURL().'?targetService='.preg_replace('/&amp;/','%26',$target_service).'&amp;pgt='.$this-&gt;getPGT();</span>
<a name="l01478"></a>01478       $cas_url = $this-&gt;<a class="code" href="group__internalConfig.html#g9062a1ea9866c4c1e5a485c0d4ee0f80">getServerProxyURL</a>().'?targetService='.urlencode($target_service).'&amp;pgt='.$this-&gt;getPGT();
<a name="l01479"></a>01479 
<a name="l01480"></a>01480       <span class="comment">// open and read the URL</span>
<a name="l01481"></a>01481       <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">readURL</a>($cas_url,''<span class="comment">/*cookies*/</span>,$headers,$cas_response,$err_msg) ) {
<a name="l01482"></a>01482         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not open URL \''.$cas_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
<a name="l01483"></a>01483         $err_code = <a class="code" href="group__publicServices.html#g7de1d5537c1fa74b4a180d94dc165c37">PHPCAS_SERVICE_PT_NO_SERVER_RESPONSE</a>;
<a name="l01484"></a>01484         $err_msg = 'could not retrieve PT (no response from the CAS server)';
<a name="l01485"></a>01485         <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(FALSE);
<a name="l01486"></a>01486         <span class="keywordflow">return</span> FALSE;
<a name="l01487"></a>01487       }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489       $bad_response = FALSE;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491       <span class="keywordflow">if</span> ( !$bad_response ) {
<a name="l01492"></a>01492         <span class="comment">// read the response of the CAS server into a DOM object</span>
<a name="l01493"></a>01493         <span class="keywordflow">if</span> ( !($dom = @<a class="code" href="domxml-php4-php5_8php.html#3842a4a076220606c7c5fe2e84eccdf7">domxml_open_mem</a>($cas_response))) {
<a name="l01494"></a>01494           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('<a class="code" href="domxml-php4-php5_8php.html#3842a4a076220606c7c5fe2e84eccdf7">domxml_open_mem</a>() failed');
<a name="l01495"></a>01495           <span class="comment">// read failed</span>
<a name="l01496"></a>01496           $bad_response = TRUE;
<a name="l01497"></a>01497         } 
<a name="l01498"></a>01498       }
<a name="l01499"></a>01499 
<a name="l01500"></a>01500       <span class="keywordflow">if</span> ( !$bad_response ) {
<a name="l01501"></a>01501         <span class="comment">// read the root node of the XML tree</span>
<a name="l01502"></a>01502         <span class="keywordflow">if</span> ( !($root = $dom-&gt;document_element()) ) {
<a name="l01503"></a>01503           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('document_element() failed');
<a name="l01504"></a>01504           <span class="comment">// read failed</span>
<a name="l01505"></a>01505           $bad_response = TRUE;
<a name="l01506"></a>01506         } 
<a name="l01507"></a>01507       }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509       <span class="keywordflow">if</span> ( !$bad_response ) {
<a name="l01510"></a>01510         <span class="comment">// insure that tag name is 'serviceResponse'</span>
<a name="l01511"></a>01511         <span class="keywordflow">if</span> ( $root-&gt;node_name() != 'serviceResponse' ) {
<a name="l01512"></a>01512           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('node_name() failed');
<a name="l01513"></a>01513           <span class="comment">// bad root node</span>
<a name="l01514"></a>01514           $bad_response = TRUE;
<a name="l01515"></a>01515         } 
<a name="l01516"></a>01516       }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518       <span class="keywordflow">if</span> ( !$bad_response ) {
<a name="l01519"></a>01519         <span class="comment">// look for a proxySuccess tag</span>
<a name="l01520"></a>01520         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxySuccess"</span>)) != 0) {
<a name="l01521"></a>01521           <span class="comment">// authentication succeded, look for a proxyTicket tag</span>
<a name="l01522"></a>01522           <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyTicket"</span>)) != 0) {
<a name="l01523"></a>01523             $err_code = <a class="code" href="group__publicServices.html#g30974f0204d0c1e9cf8b0807a1a1a55e">PHPCAS_SERVICE_OK</a>;
<a name="l01524"></a>01524             $err_msg = '';
<a name="l01525"></a>01525         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('original PT: '.trim($arr[0]-&gt;get_content()));
<a name="l01526"></a>01526         $pt = trim($arr[0]-&gt;get_content());
<a name="l01527"></a>01527             <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($pt);
<a name="l01528"></a>01528             <span class="keywordflow">return</span> $pt;
<a name="l01529"></a>01529           } <span class="keywordflow">else</span> {
<a name="l01530"></a>01530             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('&lt;proxySuccess&gt; was found, but not &lt;proxyTicket&gt;');
<a name="l01531"></a>01531           }
<a name="l01532"></a>01532         } 
<a name="l01533"></a>01533         <span class="comment">// look for a proxyFailure tag</span>
<a name="l01534"></a>01534         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $root-&gt;get_elements_by_tagname(<span class="stringliteral">"proxyFailure"</span>)) != 0) {
<a name="l01535"></a>01535           <span class="comment">// authentication failed, extract the error</span>
<a name="l01536"></a>01536           $err_code = <a class="code" href="group__publicServices.html#g63639adfb3fdbe13a1708e4823380b4d">PHPCAS_SERVICE_PT_FAILURE</a>;
<a name="l01537"></a>01537           $err_msg = 'PT retrieving failed (code=`'
<a name="l01538"></a>01538             .$arr[0]-&gt;get_attribute('code')
<a name="l01539"></a>01539             .<span class="charliteral">'\'</span>, message=`'
<a name="l01540"></a>01540             .trim($arr[0]-&gt;get_content())
<a name="l01541"></a>01541             .<span class="charliteral">'\'</span>)';
<a name="l01542"></a>01542           <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(FALSE);
<a name="l01543"></a>01543           <span class="keywordflow">return</span> FALSE;
<a name="l01544"></a>01544         } <span class="keywordflow">else</span> {
<a name="l01545"></a>01545           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('neither &lt;proxySuccess&gt; nor &lt;proxyFailure&gt; found');
<a name="l01546"></a>01546         }
<a name="l01547"></a>01547       }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549       <span class="comment">// at this step, we are sure that the response of the CAS server was ill-formed</span>
<a name="l01550"></a>01550       $err_code = <a class="code" href="group__publicServices.html#gb8fd1de27f50f53dac55bf1287ad0e70">PHPCAS_SERVICE_PT_BAD_SERVER_RESPONSE</a>;
<a name="l01551"></a>01551       $err_msg = 'Invalid response from the CAS server (response=`'.$cas_response.<span class="charliteral">'\'</span>)';
<a name="l01552"></a>01552 
<a name="l01553"></a>01553       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(FALSE);
<a name="l01554"></a>01554       <span class="keywordflow">return</span> FALSE;
<a name="l01555"></a>01555     }
<a name="l01556"></a>01556 
<a name="l01557"></a>01557   <span class="comment">// ########################################################################</span>
<a name="l01558"></a>01558   <span class="comment">// ACCESS TO EXTERNAL SERVICES</span>
<a name="l01559"></a>01559   <span class="comment">// ########################################################################</span>
<a name="l01560"></a>01560 
<a name="l01576"></a><a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">01576</a>   function <a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">readURL</a>($url,$cookies,&amp;$headers,&amp;$body,&amp;$err_msg)
<a name="l01577"></a>01577     {
<a name="l01578"></a>01578       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01579"></a>01579       $headers = '';
<a name="l01580"></a>01580       $body = '';
<a name="l01581"></a>01581       $err_msg = '';
<a name="l01582"></a>01582 
<a name="l01583"></a>01583       $res = TRUE;
<a name="l01584"></a>01584 
<a name="l01585"></a>01585       <span class="comment">// initialize the CURL session</span>
<a name="l01586"></a>01586       $ch = curl_init($url);
<a name="l01587"></a>01587         
<a name="l01588"></a>01588           <span class="comment">// verify the the server's certificate corresponds to its name</span>
<a name="l01589"></a>01589           curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 1);
<a name="l01590"></a>01590           <span class="comment">// but do not verify the certificate itself</span>
<a name="l01591"></a>01591           curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
<a name="l01592"></a>01592 
<a name="l01593"></a>01593       <span class="comment">// return the CURL output into a variable</span>
<a name="l01594"></a>01594       curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
<a name="l01595"></a>01595       <span class="comment">// include the HTTP header with the body</span>
<a name="l01596"></a>01596       curl_setopt($ch, CURLOPT_HEADER, 1);
<a name="l01597"></a>01597       <span class="comment">// add cookies headers</span>
<a name="l01598"></a>01598       <span class="keywordflow">if</span> ( is_array($cookies) ) {
<a name="l01599"></a>01599         curl_setopt($ch,CURLOPT_COOKIE,implode(<span class="charliteral">';'</span>,$cookies));
<a name="l01600"></a>01600       }
<a name="l01601"></a>01601       <span class="comment">// perform the query</span>
<a name="l01602"></a>01602       $buf = curl_exec ($ch);
<a name="l01603"></a>01603       <span class="keywordflow">if</span> ( $buf === FALSE ) {
<a name="l01604"></a>01604         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('cur_exec() failed');
<a name="l01605"></a>01605         $err_msg = 'CURL error #'.curl_errno($ch).': '.curl_error($ch);
<a name="l01606"></a>01606         <span class="comment">// close the CURL session</span>
<a name="l01607"></a>01607         curl_close ($ch);
<a name="l01608"></a>01608         $res = FALSE;
<a name="l01609"></a>01609       } <span class="keywordflow">else</span> {
<a name="l01610"></a>01610         <span class="comment">// close the CURL session</span>
<a name="l01611"></a>01611         curl_close ($ch);
<a name="l01612"></a>01612         
<a name="l01613"></a>01613         <span class="comment">// find the end of the headers</span>
<a name="l01614"></a>01614         <span class="comment">// note: strpos($str,"\n\r\n\r") does not work (?)</span>
<a name="l01615"></a>01615         $pos = FALSE;
<a name="l01616"></a>01616         <span class="keywordflow">for</span> ($i=0; $i&lt;strlen($buf); $i++) {
<a name="l01617"></a>01617           <span class="keywordflow">if</span> ( $buf[$i] == chr(13) ) 
<a name="l01618"></a>01618             <span class="keywordflow">if</span> ( $buf[$i+1] == chr(10) ) 
<a name="l01619"></a>01619               <span class="keywordflow">if</span> ( $buf[$i+2] == chr(13) ) 
<a name="l01620"></a>01620                 <span class="keywordflow">if</span> ( $buf[$i+3] == chr(10) ) {
<a name="l01621"></a>01621                   <span class="comment">// header found</span>
<a name="l01622"></a>01622                   $pos = $i;
<a name="l01623"></a>01623                   <span class="keywordflow">break</span>;
<a name="l01624"></a>01624                 }
<a name="l01625"></a>01625         }
<a name="l01626"></a>01626         
<a name="l01627"></a>01627         <span class="keywordflow">if</span> ( $pos === FALSE ) {
<a name="l01628"></a>01628           <span class="comment">// end of header not found</span>
<a name="l01629"></a>01629           $err_msg = 'no header found';
<a name="l01630"></a>01630           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>($err_msg);
<a name="l01631"></a>01631           $res = FALSE;
<a name="l01632"></a>01632         } <span class="keywordflow">else</span> { 
<a name="l01633"></a>01633           <span class="comment">// extract headers into an array</span>
<a name="l01634"></a>01634           $headers = preg_split (<span class="stringliteral">"/[\n\r]+/"</span>,substr($buf,0,$pos));        
<a name="l01635"></a>01635           <span class="comment">// extract body into a string</span>
<a name="l01636"></a>01636           $body = substr($buf,$pos+4);
<a name="l01637"></a>01637         }
<a name="l01638"></a>01638       }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($res);
<a name="l01641"></a>01641       <span class="keywordflow">return</span> $res;
<a name="l01642"></a>01642     }
<a name="l01643"></a>01643 
<a name="l01659"></a><a class="code" href="group__internalPGTStorage.html#g193806008e1fc68c4d8f384366f13b3e">01659</a>   function <a class="code" href="group__internalPGTStorage.html#g193806008e1fc68c4d8f384366f13b3e">serviceWeb</a>($url,&amp;$err_code,&amp;$output)
<a name="l01660"></a>01660     {
<a name="l01661"></a>01661       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01662"></a>01662       <span class="comment">// at first retrieve a PT</span>
<a name="l01663"></a>01663       $pt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#g6653e51d995e8a13a2f758f93e7dc7a0">retrievePT</a>($url,$err_code,$output);
<a name="l01664"></a>01664 
<a name="l01665"></a>01665       $res = TRUE;
<a name="l01666"></a>01666       
<a name="l01667"></a>01667       <span class="comment">// test if PT was retrieved correctly</span>
<a name="l01668"></a>01668       <span class="keywordflow">if</span> ( !$pt ) {
<a name="l01669"></a>01669         <span class="comment">// note: $err_code and $err_msg are filled by CASClient::retrievePT()</span>
<a name="l01670"></a>01670         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PT was not retrieved correctly');
<a name="l01671"></a>01671         $res = FALSE;
<a name="l01672"></a>01672       } <span class="keywordflow">else</span> {
<a name="l01673"></a>01673         <span class="comment">// add cookies if necessary</span>
<a name="l01674"></a>01674         <span class="keywordflow">if</span> ( is_array($_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies']) ) {
<a name="l01675"></a>01675           foreach ( $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies'] as $name =&gt; $val ) { 
<a name="l01676"></a>01676             $cookies[] = $name.<span class="charliteral">'='</span>.$val;
<a name="l01677"></a>01677           }
<a name="l01678"></a>01678         }
<a name="l01679"></a>01679         
<a name="l01680"></a>01680         <span class="comment">// build the URL including the PT</span>
<a name="l01681"></a>01681         <span class="keywordflow">if</span> ( strstr($url,<span class="charliteral">'?'</span>) === FALSE ) {
<a name="l01682"></a>01682           $service_url = $url.'?ticket='.$pt;
<a name="l01683"></a>01683         } <span class="keywordflow">else</span> {
<a name="l01684"></a>01684           $service_url = $url.'&amp;ticket='.$pt;
<a name="l01685"></a>01685         }
<a name="l01686"></a>01686         
<a name="l01687"></a>01687         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('reading URL`'.$service_url.<span class="charliteral">'\''</span>);
<a name="l01688"></a>01688         <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">readURL</a>($service_url,$cookies,$headers,$output,$err_msg) ) {
<a name="l01689"></a>01689           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not read URL`'.$service_url.<span class="charliteral">'\''</span>);
<a name="l01690"></a>01690           $err_code = PHPCAS_SERVICE_NOT_AVAILABLE;
<a name="l01691"></a>01691           <span class="comment">// give an error message</span>
<a name="l01692"></a>01692           $output = sprintf($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#bbacf10862ddf542ca5bf4dcebe26882">CAS_STR_SERVICE_UNAVAILABLE</a>),
<a name="l01693"></a>01693                             $service_url,
<a name="l01694"></a>01694                             $err_msg);
<a name="l01695"></a>01695           $res = FALSE;
<a name="l01696"></a>01696         } <span class="keywordflow">else</span> {
<a name="l01697"></a>01697           <span class="comment">// URL has been fetched, extract the cookies</span>
<a name="l01698"></a>01698           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('URL`'.$service_url.<span class="charliteral">'\'</span> has been read, storing cookies:');
<a name="l01699"></a>01699           foreach ( $headers as $header ) {
<a name="l01700"></a>01700             <span class="comment">// test if the header is a cookie</span>
<a name="l01701"></a>01701             <span class="keywordflow">if</span> ( preg_match('/^Set-Cookie:/',$header) ) {
<a name="l01702"></a>01702               <span class="comment">// the header is a cookie, remove the beginning</span>
<a name="l01703"></a>01703               $header_val = preg_replace('/^Set-Cookie: */<span class="charliteral">','</span>',$header);
<a name="l01704"></a>01704               <span class="comment">// extract interesting information</span>
<a name="l01705"></a>01705               $name_val = strtok($header_val,'; ');
<a name="l01706"></a>01706               <span class="comment">// extract the name and the value of the cookie</span>
<a name="l01707"></a>01707               $cookie_name = strtok($name_val,<span class="charliteral">'='</span>);
<a name="l01708"></a>01708               $cookie_val = strtok(<span class="charliteral">'='</span>);
<a name="l01709"></a>01709               <span class="comment">// store the cookie </span>
<a name="l01710"></a>01710               $_SESSION['<a class="code" href="classphpCAS.html">phpCAS</a>']['services'][$url]['cookies'][$cookie_name] = $cookie_val;
<a name="l01711"></a>01711               <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>($cookie_name.' -&gt; '.$cookie_val);
<a name="l01712"></a>01712             }
<a name="l01713"></a>01713           }
<a name="l01714"></a>01714         }
<a name="l01715"></a>01715       }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($res);
<a name="l01718"></a>01718       <span class="keywordflow">return</span> $res;
<a name="l01719"></a>01719   }
<a name="l01720"></a>01720 
<a name="l01739"></a><a class="code" href="group__internalPGTStorage.html#g11310ac24c9f5405129b2a47de8d20ee">01739</a>   function <a class="code" href="group__internalPGTStorage.html#g11310ac24c9f5405129b2a47de8d20ee">serviceMail</a>($url,$flags,&amp;$err_code,&amp;$err_msg,&amp;$pt)
<a name="l01740"></a>01740     {
<a name="l01741"></a>01741       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01742"></a>01742       <span class="comment">// at first retrieve a PT</span>
<a name="l01743"></a>01743       $pt = $this-&gt;<a class="code" href="group__internalPGTStorage.html#g6653e51d995e8a13a2f758f93e7dc7a0">retrievePT</a>($target_service,$err_code,$output);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745       $stream = FALSE;
<a name="l01746"></a>01746       
<a name="l01747"></a>01747       <span class="comment">// test if PT was retrieved correctly</span>
<a name="l01748"></a>01748       <span class="keywordflow">if</span> ( !$pt ) {
<a name="l01749"></a>01749         <span class="comment">// note: $err_code and $err_msg are filled by CASClient::retrievePT()</span>
<a name="l01750"></a>01750         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('PT was not retrieved correctly');
<a name="l01751"></a>01751       } <span class="keywordflow">else</span> {
<a name="l01752"></a>01752         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('opening IMAP URL `'.$url.<span class="charliteral">'\'</span>...');
<a name="l01753"></a>01753         $stream = @imap_open($url,$this-&gt;<a class="code" href="group__internalAuthentication.html#gb3ffd6b93090db528cf062a65ac37cfc">getUser</a>(),$pt,$flags);
<a name="l01754"></a>01754         <span class="keywordflow">if</span> ( !$stream ) {
<a name="l01755"></a>01755           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not open URL');
<a name="l01756"></a>01756           $err_code = PHPCAS_SERVICE_NOT_AVAILABLE;
<a name="l01757"></a>01757           <span class="comment">// give an error message</span>
<a name="l01758"></a>01758           $err_msg = sprintf($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#bbacf10862ddf542ca5bf4dcebe26882">CAS_STR_SERVICE_UNAVAILABLE</a>),
<a name="l01759"></a>01759                              $service_url,
<a name="l01760"></a>01760                              var_export(imap_errors(),TRUE));
<a name="l01761"></a>01761           $pt = FALSE;
<a name="l01762"></a>01762           $stream = FALSE;
<a name="l01763"></a>01763         } <span class="keywordflow">else</span> {
<a name="l01764"></a>01764           <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('ok');
<a name="l01765"></a>01765         }
<a name="l01766"></a>01766       }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($stream);
<a name="l01769"></a>01769       <span class="keywordflow">return</span> $stream;
<a name="l01770"></a>01770   }
<a name="l01771"></a>01771 
<a name="l01774"></a>01774   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01775"></a>01775   <span class="comment">// XX                                                                    XX</span>
<a name="l01776"></a>01776   <span class="comment">// XX                  PROXIED CLIENT FEATURES (CAS 2.0)                 XX</span>
<a name="l01777"></a>01777   <span class="comment">// XX                                                                    XX</span>
<a name="l01778"></a>01778   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01779"></a>01779 
<a name="l01780"></a>01780   <span class="comment">// ########################################################################</span>
<a name="l01781"></a>01781   <span class="comment">//  PT</span>
<a name="l01782"></a>01782   <span class="comment">// ########################################################################</span>
<a name="l01796"></a><a class="code" href="group__internalProxied.html#g871da1b6b42d8afdab4198bf2d38cadc">01796</a> <span class="comment"></span>  var <a class="code" href="group__internalProxied.html#g871da1b6b42d8afdab4198bf2d38cadc">$_pt</a> = '';
<a name="l01797"></a>01797   
<a name="l01803"></a><a class="code" href="group__internalProxied.html#gf916fb31175e9dd4b8f383f6f6085982">01803</a>   function <a class="code" href="group__internalProxied.html#gf916fb31175e9dd4b8f383f6f6085982">getPT</a>()
<a name="l01804"></a>01804     {
<a name="l01805"></a>01805       <span class="keywordflow">return</span> 'ST'.substr($this-&gt;_pt, 2);
<a name="l01806"></a>01806     }
<a name="l01807"></a>01807 
<a name="l01813"></a><a class="code" href="group__internalProxied.html#g23e26824081b516fcbe856f459249956">01813</a>   function <a class="code" href="group__internalProxied.html#g23e26824081b516fcbe856f459249956">setPT</a>($pt)
<a name="l01814"></a>01814     { $this-&gt;_pt = $pt; }
<a name="l01815"></a>01815 
<a name="l01821"></a><a class="code" href="group__internalProxied.html#g72ebeda5e6c9dbaac0e1e20a9e6419e4">01821</a>   function <a class="code" href="group__internalProxied.html#g72ebeda5e6c9dbaac0e1e20a9e6419e4">hasPT</a>()
<a name="l01822"></a>01822     { <span class="keywordflow">return</span> !empty($this-&gt;_pt); }
<a name="l01823"></a>01823 
<a name="l01825"></a>01825   <span class="comment">// ########################################################################</span>
<a name="l01826"></a>01826   <span class="comment">//  PT VALIDATION</span>
<a name="l01827"></a>01827   <span class="comment">// ########################################################################</span>
<a name="l01840"></a><a class="code" href="group__internalProxied.html#g59ed21e8f3d40c8f33d277ca7ea3224f">01840</a> <span class="comment"></span>  function <a class="code" href="group__internalProxied.html#g59ed21e8f3d40c8f33d277ca7ea3224f">validatePT</a>(&amp;$validate_url,&amp;$text_response,&amp;$tree_response)
<a name="l01841"></a>01841     {
<a name="l01842"></a>01842       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01843"></a>01843       <span class="comment">// build the URL to validate the ticket</span>
<a name="l01844"></a>01844       $validate_url = $this-&gt;<a class="code" href="group__internalConfig.html#g900e70b93d8aa16bccd11de19c9322f6">getServerProxyValidateURL</a>().'&amp;ticket='.$this-&gt;getPT();
<a name="l01845"></a>01845 
<a name="l01846"></a>01846       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="group__internalProxy.html#g2fc9093d2b76fdcce819ca693021f0c9">isProxy</a>() ) {
<a name="l01847"></a>01847       <span class="comment">// pass the callback url for CAS proxies</span>
<a name="l01848"></a>01848         $validate_url .= '&amp;pgtUrl='.$this-&gt;getCallbackURL();
<a name="l01849"></a>01849       }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851       <span class="comment">// open and read the URL</span>
<a name="l01852"></a>01852       <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="group__internalPGTStorage.html#gd615ece3809389418cc18b099369f2a4">readURL</a>($validate_url,''<span class="comment">/*cookies*/</span>,$headers,$text_response,$err_msg) ) {
<a name="l01853"></a>01853         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('could not open URL \''.$validate_url.<span class="charliteral">'\'</span> to validate ('.$err_msg.<span class="charliteral">')'</span>);
<a name="l01854"></a>01854         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01855"></a>01855                          $validate_url,
<a name="l01856"></a>01856                          TRUE<span class="comment">/*$no_response*/</span>);
<a name="l01857"></a>01857       }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859       <span class="comment">// read the response of the CAS server into a DOM object</span>
<a name="l01860"></a>01860       <span class="keywordflow">if</span> ( !($dom = <a class="code" href="domxml-php4-php5_8php.html#3842a4a076220606c7c5fe2e84eccdf7">domxml_open_mem</a>($text_response))) {
<a name="l01861"></a>01861         <span class="comment">// read failed</span>
<a name="l01862"></a>01862         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01863"></a>01863                      $validate_url,
<a name="l01864"></a>01864                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01865"></a>01865                      TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01866"></a>01866                      $text_response);
<a name="l01867"></a>01867       }
<a name="l01868"></a>01868       <span class="comment">// read the root node of the XML tree</span>
<a name="l01869"></a>01869       <span class="keywordflow">if</span> ( !($tree_response = $dom-&gt;document_element()) ) {
<a name="l01870"></a>01870         <span class="comment">// read failed</span>
<a name="l01871"></a>01871         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01872"></a>01872                      $validate_url,
<a name="l01873"></a>01873                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01874"></a>01874                      TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01875"></a>01875                      $text_response);
<a name="l01876"></a>01876       }
<a name="l01877"></a>01877       <span class="comment">// insure that tag name is 'serviceResponse'</span>
<a name="l01878"></a>01878       <span class="keywordflow">if</span> ( $tree_response-&gt;node_name() != 'serviceResponse' ) {
<a name="l01879"></a>01879         <span class="comment">// bad root node</span>
<a name="l01880"></a>01880         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01881"></a>01881                      $validate_url,
<a name="l01882"></a>01882                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01883"></a>01883                      TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01884"></a>01884                      $text_response);
<a name="l01885"></a>01885       }
<a name="l01886"></a>01886       <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationSuccess"</span>)) != 0) {
<a name="l01887"></a>01887         <span class="comment">// authentication succeded, extract the user name</span>
<a name="l01888"></a>01888         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"user"</span>)) == 0) {
<a name="l01889"></a>01889           <span class="comment">// no user specified =&gt; error</span>
<a name="l01890"></a>01890           $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01891"></a>01891                        $validate_url,
<a name="l01892"></a>01892                        FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01893"></a>01893                        TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01894"></a>01894                        $text_response);
<a name="l01895"></a>01895         }
<a name="l01896"></a>01896         $this-&gt;<a class="code" href="group__internalAuthentication.html#ga777df1226ebeb2b85179af753c51109">setUser</a>(trim($arr[0]-&gt;get_content()));
<a name="l01897"></a>01897         
<a name="l01898"></a>01898       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>($arr = $tree_response-&gt;get_elements_by_tagname(<span class="stringliteral">"authenticationFailure"</span>)) != 0) {
<a name="l01899"></a>01899         <span class="comment">// authentication succeded, extract the error code and message</span>
<a name="l01900"></a>01900         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01901"></a>01901                      $validate_url,
<a name="l01902"></a>01902                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01903"></a>01903                      FALSE<span class="comment">/*$bad_response*/</span>,
<a name="l01904"></a>01904                      $text_response,
<a name="l01905"></a>01905                      $arr[0]-&gt;get_attribute('code')<span class="comment">/*$err_code*/</span>,
<a name="l01906"></a>01906                      trim($arr[0]-&gt;get_content())<span class="comment">/*$err_msg*/</span>);
<a name="l01907"></a>01907       } <span class="keywordflow">else</span> {
<a name="l01908"></a>01908         $this-&gt;<a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>('PT not validated',
<a name="l01909"></a>01909                      $validate_url,     
<a name="l01910"></a>01910                      FALSE<span class="comment">/*$no_response*/</span>,
<a name="l01911"></a>01911                      TRUE<span class="comment">/*$bad_response*/</span>,
<a name="l01912"></a>01912                      $text_response);
<a name="l01913"></a>01913       }
<a name="l01914"></a>01914       
<a name="l01915"></a>01915       <span class="comment">// at this step, PT has been validated and $this-&gt;_user has been set,</span>
<a name="l01916"></a>01916 
<a name="l01917"></a>01917       <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>(TRUE);
<a name="l01918"></a>01918       <span class="keywordflow">return</span> TRUE;
<a name="l01919"></a>01919     }
<a name="l01920"></a>01920 
<a name="l01923"></a>01923   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01924"></a>01924   <span class="comment">// XX                                                                    XX</span>
<a name="l01925"></a>01925   <span class="comment">// XX                               MISC                                 XX</span>
<a name="l01926"></a>01926   <span class="comment">// XX                                                                    XX</span>
<a name="l01927"></a>01927   <span class="comment">// XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span>
<a name="l01928"></a>01928 
<a name="l01934"></a>01934   <span class="comment">// ########################################################################</span>
<a name="l01935"></a>01935   <span class="comment">//  URL</span>
<a name="l01936"></a>01936   <span class="comment">// ########################################################################</span>
<a name="l01944"></a><a class="code" href="group__internalMisc.html#ge81fd3e2221392281541b41a973b965c">01944</a> <span class="comment"></span>  var <a class="code" href="group__internalMisc.html#ge81fd3e2221392281541b41a973b965c">$_url</a> = '';
<a name="l01945"></a>01945 
<a name="l01954"></a><a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">01954</a>   function <a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">getURL</a>()
<a name="l01955"></a>01955     {
<a name="l01956"></a>01956       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l01957"></a>01957       <span class="comment">// the URL is built when needed only</span>
<a name="l01958"></a>01958       <span class="keywordflow">if</span> ( empty($this-&gt;_url) ) {
<a name="l01959"></a>01959             $final_uri = '';
<a name="l01960"></a>01960             <span class="comment">// remove the ticket if present in the URL</span>
<a name="l01961"></a>01961             $final_uri = ($this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>()) ? 'https' : 'http';
<a name="l01962"></a>01962             $final_uri .= ':<span class="comment">//';</span>
<a name="l01963"></a>01963             <span class="comment">/* replaced by Julien Marchal - v0.4.6</span>
<a name="l01964"></a>01964 <span class="comment">             * $this-&gt;_url .= $_SERVER['SERVER_NAME'];</span>
<a name="l01965"></a>01965 <span class="comment">             */</span>
<a name="l01966"></a>01966         <span class="keywordflow">if</span>(empty($_SERVER['HTTP_X_FORWARDED_SERVER'])){
<a name="l01967"></a>01967           <span class="comment">/* replaced by teedog - v0.4.12</span>
<a name="l01968"></a>01968 <span class="comment">           * $this-&gt;_url .= $_SERVER['SERVER_NAME'];</span>
<a name="l01969"></a>01969 <span class="comment">           */</span>
<a name="l01970"></a>01970           <span class="keywordflow">if</span> (empty($_SERVER['SERVER_NAME'])) {
<a name="l01971"></a>01971             $server_name = $_SERVER['HTTP_HOST'];
<a name="l01972"></a>01972           } <span class="keywordflow">else</span> {
<a name="l01973"></a>01973             $server_name = $_SERVER['SERVER_NAME'];
<a name="l01974"></a>01974           }
<a name="l01975"></a>01975         } <span class="keywordflow">else</span> {
<a name="l01976"></a>01976           $server_name = $_SERVER['HTTP_X_FORWARDED_SERVER'];
<a name="l01977"></a>01977         }
<a name="l01978"></a>01978       $final_uri .= $server_name;
<a name="l01979"></a>01979       <span class="keywordflow">if</span> (!strpos($server_name, <span class="charliteral">':'</span>)) {
<a name="l01980"></a>01980             <span class="keywordflow">if</span> ( ($this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=443)
<a name="l01981"></a>01981                || (!$this-&gt;<a class="code" href="group__internalConfig.html#g38aaa519cdc07340eccf41333cd45975">isHttps</a>() &amp;&amp; $_SERVER['SERVER_PORT']!=80) ) {
<a name="l01982"></a>01982               $final_uri .= <span class="charliteral">':'</span>;
<a name="l01983"></a>01983               $final_uri .= $_SERVER['SERVER_PORT'];
<a name="l01984"></a>01984             }
<a name="l01985"></a>01985       }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987           $final_uri .= strtok($_SERVER['REQUEST_URI'],<span class="stringliteral">"?"</span>);
<a name="l01988"></a>01988           $cgi_params = <span class="charliteral">'?'</span>.strtok(<span class="stringliteral">"?"</span>);
<a name="l01989"></a>01989           <span class="comment">// remove the ticket if present in the CGI parameters</span>
<a name="l01990"></a>01990           $cgi_params = preg_replace('/&amp;ticket=[^&amp;]*/<span class="charliteral">','</span>',$cgi_params);
<a name="l01991"></a>01991           $cgi_params = preg_replace('/\?ticket=[^&amp;;]*/<span class="charliteral">','</span>?',$cgi_params);
<a name="l01992"></a>01992           $cgi_params = preg_replace('/\?%26/<span class="charliteral">','</span>?',$cgi_params);
<a name="l01993"></a>01993           $cgi_params = preg_replace('/\?&amp;/<span class="charliteral">','</span>?',$cgi_params);
<a name="l01994"></a>01994           $cgi_params = preg_replace('/\?$/<span class="charliteral">','</span>',$cgi_params);
<a name="l01995"></a>01995           $final_uri .= $cgi_params;
<a name="l01996"></a>01996           $this-&gt;<a class="code" href="group__internalMisc.html#g1a5732046154c0f69d040513309af5d1">setURL</a>($final_uri);
<a name="l01997"></a>01997     }
<a name="l01998"></a>01998     <a class="code" href="group__internalDebug.html#gf19e79b09517570e32a8e597a096dc76">phpCAS::traceEnd</a>($this-&gt;_url);
<a name="l01999"></a>01999     <span class="keywordflow">return</span> $this-&gt;_url;
<a name="l02000"></a>02000   }
<a name="l02001"></a>02001 
<a name="l02009"></a><a class="code" href="group__internalMisc.html#g1a5732046154c0f69d040513309af5d1">02009</a>   function <a class="code" href="group__internalMisc.html#g1a5732046154c0f69d040513309af5d1">setURL</a>($url)
<a name="l02010"></a>02010     {
<a name="l02011"></a>02011       $this-&gt;_url = $url;
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013   
<a name="l02014"></a>02014   <span class="comment">// ########################################################################</span>
<a name="l02015"></a>02015   <span class="comment">//  AUTHENTICATION ERROR HANDLING</span>
<a name="l02016"></a>02016   <span class="comment">// ########################################################################</span>
<a name="l02032"></a><a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">02032</a> <span class="comment"></span>  function <a class="code" href="group__internalMisc.html#g4dda8e03389ad8a515d4e45cb42859ca">authError</a>($failure,$cas_url,$no_response,$bad_response='',$cas_response='',$err_code='',$err_msg='')
<a name="l02033"></a>02033     {
<a name="l02034"></a>02034       <a class="code" href="group__internalDebug.html#g96b9ac0ffbf2ee8c4754c6ca878eb2d6">phpCAS::traceBegin</a>();
<a name="l02035"></a>02035 
<a name="l02036"></a>02036       $this-&gt;<a class="code" href="group__internalOutput.html#g729d029afcd908c73f4cd953fbb93ff6">printHTMLHeader</a>($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#54b561ecd13a0e2d6d916e33d92a550d">CAS_STR_AUTHENTICATION_FAILED</a>));
<a name="l02037"></a>02037       printf($this-&gt;<a class="code" href="group__internalLang.html#ge6d54280d83248f1b123b91aae12f944">getString</a>(<a class="code" href="languages_8php.html#f832fd46e6e716b47f2c711aa96fe197">CAS_STR_YOU_WERE_NOT_AUTHENTICATED</a>),$this-&gt;<a class="code" href="group__internalMisc.html#gcb55b82062ce0ebfbcec711b87024fe0">getURL</a>(),$_SERVER['SERVER_ADMIN']);
<a name="l02038"></a>02038       <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('CAS URL: '.$cas_url);
<a name="l02039"></a>02039       <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Authentication failure: '.$failure);
<a name="l02040"></a>02040       <span class="keywordflow">if</span> ( $no_response ) {
<a name="l02041"></a>02041         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Reason: no response from the CAS server');
<a name="l02042"></a>02042       } <span class="keywordflow">else</span> {
<a name="l02043"></a>02043         <span class="keywordflow">if</span> ( $bad_response ) {
<a name="l02044"></a>02044             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Reason: bad response from the CAS server');
<a name="l02045"></a>02045         } <span class="keywordflow">else</span> {
<a name="l02046"></a>02046           <span class="keywordflow">switch</span> ($this-&gt;<a class="code" href="group__internalConfig.html#g2fd21c11b4e3878c82bc65af39fd40ba">getServerVersion</a>()) {
<a name="l02047"></a>02047           <span class="keywordflow">case</span> <a class="code" href="group__public.html#g0904e4fb51e532bbba51832326dbf8fb">CAS_VERSION_1_0</a>:
<a name="l02048"></a>02048             <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Reason: CAS error');
<a name="l02049"></a>02049             <span class="keywordflow">break</span>;
<a name="l02050"></a>02050           <span class="keywordflow">case</span> <a class="code" href="group__public.html#g33db27557b9b055f0cff75481f46a4bc">CAS_VERSION_2_0</a>:
<a name="l02051"></a>02051             <span class="keywordflow">if</span> ( empty($err_code) )
<a name="l02052"></a>02052               <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Reason: no CAS error');
<a name="l02053"></a>02053             <span class="keywordflow">else</span>
<a name="l02054"></a>02054               <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('Reason: ['.$err_code.'] CAS error: '.$err_msg);
<a name="l02055"></a>02055             <span class="keywordflow">break</span>;
<a name="l02056"></a>02056           }
<a name="l02057"></a>02057         }
<a name="l02058"></a>02058         <a class="code" href="group__internalDebug.html#g8939d840392aa6cf54b57f2e28b77419">phpCAS::trace</a>('CAS response: '.$cas_response);
<a name="l02059"></a>02059       }
<a name="l02060"></a>02060       $this-&gt;<a class="code" href="group__internalOutput.html#gf4185028c6d4054757164c8919e592aa">printHTMLFooter</a>();
<a name="l02061"></a>02061       <a class="code" href="group__internalDebug.html#g38887ed1896e7ba9f0e440a3d8ef17ae">phpCAS::traceExit</a>();
<a name="l02062"></a>02062       exit();
<a name="l02063"></a>02063     }
<a name="l02064"></a>02064 
<a name="l02066"></a>02066 }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Mar 14 14:55:56 2007 for phpCAS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.0 </small></address>
</body>
</html>
